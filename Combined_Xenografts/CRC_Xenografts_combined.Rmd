---
title: "Combined xenografts"
author: Sophie Herbst
output:
  html_document:
    code_folding: hide
    toc: yes
    toc_depth: 4
    toc_float: yes
editor_options: 
  chunk_output_type: console
---
Analysis date: `r Sys.Date()`

# Depends on
CRC_Xenografts_Batch2_DataProcessing Script
Xenografts_Batch1_2_DataProcessing Script

# Setup
## Load libraries and functions
```{r, echo=FALSE, warning=FALSE, message=FALSE}
set.seed(2022)
library(fgsea)
library(AnnotationDbi)
library(org.Hs.eg.db)
library(DEP)
library(SummarizedExperiment)
# library(pls)
library(mdatools)
source("../../../General/Code/Analysis_Functions.R")
source("CRC_Xenografts_Combined_Functions.R")
```

## Load data and process
### Batch 1
#### Load
```{r}
load("../Data/Cache/Xenografts_Batch1_2_DataProcessing.RData")
```

#### Process
##### Combine
```{r}
all_pY_peptides_form <- rbind( (pY_Set1_form %>% select('Annotated_Sequence', 'HGNC_Symbol', 'Master.Protein.Accessions', 'Master.Protein.Descriptions') ), 
(pY_Set2_form %>% select('Annotated_Sequence', 'HGNC_Symbol', 'Master.Protein.Accessions', 'Master.Protein.Descriptions') ) ) %>%
  unique

pY_Batch1_form <- plyr::join_all(list(all_pY_peptides_form, pY_Set1_form,
                    pY_Set2_form), 
               by=c('Annotated_Sequence', 'HGNC_Symbol', 'Master.Protein.Accessions', 'Master.Protein.Descriptions' ), 
               type='left') %>% as_tibble() 

pY_Batch1_form
pY_mat_Batch1 <- pY_Batch1_form %>% 
  mutate( rname = paste0( HGNC_Symbol, "_", Annotated_Sequence) ) %>%
  column_to_rownames("rname") %>%
  select(all_of( contains("Xenograft") )) %>%
  as.matrix() %>%
  t
pY_mat_Batch1[1:5,1:5]
```

##### By condition
###### All
```{r}
pY_Batch1_by_cond <- pY_Batch1_form %>%
  pivot_longer(cols = contains("Xenograft") , names_to = "sample", values_to = "log2FC_over_ctrl") %>%
  mutate(sample = str_remove( sample, "log2FC_Xenograft") ) %>%
  separate( sample , into = c("xenograft", "treatment", "timepoint", "replicate", "set"), remove = F) %>%
  group_by(Annotated_Sequence, HGNC_Symbol, Master.Protein.Accessions, Master.Protein.Descriptions, xenograft, treatment,
           timepoint) %>%
  summarise(mean_log2FC_per_xeno_treat_time = mean(log2FC_over_ctrl, na.rm = T)) %>%
  ungroup() %>%
  mutate(sample_group = paste0("Xenograft4", xenograft, "_" , treatment, "_" , timepoint )) %>%
  select(-xenograft, -treatment, -timepoint) %>%
  pivot_wider( values_from =  mean_log2FC_per_xeno_treat_time, names_from = sample_group)

sum((is.na(pY_Batch1_by_cond) %>% rowSums() ) ==0 ) 

pY_Batch1_by_cond_noNA <- pY_Batch1_by_cond %>%  .[( (is.na(pY_Batch1_by_cond ) %>% rowSums() ) ==0),]

pY_mat_Batch1_by_cond_noNA <- pY_Batch1_by_cond_noNA %>% 
  mutate( rname = paste0( HGNC_Symbol, "_", Annotated_Sequence) ) %>%
  column_to_rownames("rname") %>%
  select(all_of( contains("Xenograft") )) %>%
  as.matrix() %>%
  t

```

###### Day 5
```{r}
sum((is.na(pY_Batch1_by_cond %>% select('Annotated_Sequence', 'HGNC_Symbol', 'Master.Protein.Accessions', 'Master.Protein.Descriptions', contains("_5d")) ) %>% rowSums() ) ==0 ) 

pY_Batch1_by_cond_5d_noNA <- pY_Batch1_by_cond %>%  .[( (is.na(pY_Batch1_by_cond %>% select('Annotated_Sequence', 'HGNC_Symbol', 'Master.Protein.Accessions', 'Master.Protein.Descriptions', contains("_5d")) ) %>% rowSums() ) ==0 ), ] %>% select('Annotated_Sequence', 'HGNC_Symbol', 'Master.Protein.Accessions', 'Master.Protein.Descriptions', contains("_5d") )

pY_mat_Batch1_by_cond_5d_noNA <- pY_Batch1_by_cond_5d_noNA %>% 
  mutate( rname = paste0( HGNC_Symbol, "_", Annotated_Sequence) ) %>%
  column_to_rownames("rname") %>%
  select(all_of( contains("Xenograft") )) %>%
  as.matrix() %>%
  t

rm(list=setdiff(ls(), c("pY_mat_Batch1_by_cond_noNA", "pY_Batch1_by_cond_noNA", 
                        "pY_mat_Batch1_by_cond_5d_noNA", "pY_Batch1_by_cond_5d_noNA" )  ))
```

### Batch 2
#### Load
```{r}
load("../Data/Cache/Xenografts_Batch2_DataProcessing.RData")
```

#### Process
##### Combine
```{r}
pY_Set5_Xenograft1_form <- pY_Set5_normXenograft1_form %>% 
  select(Annotated_Sequence, HGNC_Symbol, Master.Protein.Accessions, Master.Protein.Descriptions, contains("log2FC_Xenograft1_"))
pY_Set5_Xenograft14_form <- pY_Set5_normXenograft14_form %>% 
  select(Annotated_Sequence, HGNC_Symbol, Master.Protein.Accessions, Master.Protein.Descriptions, contains("log2FC_Xenograft14_"))

warning("Temporary fix for issue with proteins MRPL58, MRPL58, RPL10A, RACK1, RPS12 and RPL15. Removed them for now.")

all_pY_peptides_form <- rbind( (pY_Set1_form %>% select('Annotated_Sequence', 'HGNC_Symbol', 'Master.Protein.Accessions', 'Master.Protein.Descriptions') ), 
                               (pY_Set2_form %>% select('Annotated_Sequence', 'HGNC_Symbol', 'Master.Protein.Accessions', 'Master.Protein.Descriptions') %>%
                                  filter(!HGNC_Symbol %in% c( "MRPL58", "MRPL58", "RACK1", "RPL10A", "RPS12",  "RPL15" ))), 
                               (pY_Set3_form %>% select('Annotated_Sequence', 'HGNC_Symbol', 'Master.Protein.Accessions', 'Master.Protein.Descriptions') ), 
                               (pY_Set4_form %>% select('Annotated_Sequence', 'HGNC_Symbol', 'Master.Protein.Accessions', 'Master.Protein.Descriptions') ),  
                               (pY_Set5_Xenograft1_form %>% select('Annotated_Sequence', 'HGNC_Symbol', 'Master.Protein.Accessions', 'Master.Protein.Descriptions') ), 
                               (pY_Set5_Xenograft14_form  %>% select('Annotated_Sequence', 'HGNC_Symbol', 'Master.Protein.Accessions', 'Master.Protein.Descriptions') ) )%>%
  unique

pY_Batch2_form <- plyr::join_all(list(all_pY_peptides_form, pY_Set1_form,  pY_Set2_form,
                    pY_Set3_form,pY_Set4_form, 
                    pY_Set5_Xenograft1_form, pY_Set5_Xenograft14_form ), 
               by=c('Annotated_Sequence', 'HGNC_Symbol', 'Master.Protein.Accessions', 'Master.Protein.Descriptions' ), 
               type='left') %>% as_tibble() 

#pY_Batch2[((is.na(pY_Batch2) %>% rowSums() ) ==0 ),] %>%
#  pivot_longer(cols = contains("Xenograft") , names_to = "sample", values_to = "log2FC_over_ctrl") %>%
#  mutate(sample = str_remove( sample, "log2FC_Xenograft") ) %>%
#  separate( sample , into = c("xenograft", "treatment", "timepoint", "replicate", "set"), remove = F) %>%
#  ggplot(aes(x = interaction(timepoint, treatment, xenograft),  y = log2FC_over_ctrl, fill = treatment) ) +
#  geom_boxplot() +
#  geom_point() +
#  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
#  facet_wrap(~ HGNC_Symbol + Annotated_Sequence)

pY_Batch2_form
pY_mat_Batch2 <- pY_Batch2_form %>% 
  mutate( rname = paste0( HGNC_Symbol, "_", Annotated_Sequence) ) %>%
  column_to_rownames("rname") %>%
  select(all_of( contains("Xenograft") )) %>%
  as.matrix() %>%
  t
pY_mat_Batch2[1:5,1:5]
```


##### By condition
###### All
```{r}
pY_Batch2_by_cond <- pY_Batch2_form %>%
  pivot_longer(cols = contains("Xenograft") , names_to = "sample", values_to = "log2FC_over_ctrl") %>%
  mutate(sample = str_remove( sample, "log2FC_Xenograft") ) %>%
  separate( sample , into = c("xenograft", "treatment", "timepoint", "replicate", "set"), remove = F) %>%
  group_by(Annotated_Sequence, HGNC_Symbol, Master.Protein.Accessions, Master.Protein.Descriptions, xenograft, treatment,
           timepoint) %>%
  summarise(mean_log2FC_per_xeno_treat_time = mean(log2FC_over_ctrl, na.rm = T)) %>%
  ungroup() %>%
  mutate(sample_group = paste0("Xenograft", xenograft, "_" , treatment, "_" , timepoint )) %>%
  select(-xenograft, -treatment, -timepoint) %>%
  pivot_wider( values_from =  mean_log2FC_per_xeno_treat_time, names_from = sample_group)

sum((is.na(pY_Batch2_by_cond %>% select(-Xenograft14_EC_24h)) %>% rowSums() ) ==0 ) 

pY_Batch2_by_cond_noNA <- pY_Batch2_by_cond %>% select(-Xenograft14_EC_24h) %>% .[( (is.na(pY_Batch2_by_cond %>% select(-Xenograft14_EC_24h)) %>% rowSums() ) ==0),]

pY_mat_Batch2_by_cond_noNA <- pY_Batch2_by_cond_noNA %>% 
  mutate( rname = paste0( HGNC_Symbol, "_", Annotated_Sequence) ) %>%
  column_to_rownames("rname") %>%
  select(all_of( contains("Xenograft") )) %>%
  as.matrix() %>%
  t

```

###### Day 5
```{r}
sum((is.na(pY_Batch2_by_cond %>% select('Annotated_Sequence', 'HGNC_Symbol', 'Master.Protein.Accessions', 'Master.Protein.Descriptions', contains("_5d")) ) %>% rowSums() ) ==0 ) 

pY_Batch2_by_cond_5d_noNA <- pY_Batch2_by_cond %>%  .[( (is.na(pY_Batch2_by_cond %>% select('Annotated_Sequence', 'HGNC_Symbol', 'Master.Protein.Accessions', 'Master.Protein.Descriptions', contains("_5d")) ) %>% rowSums() ) ==0 ), ] %>% select('Annotated_Sequence', 'HGNC_Symbol', 'Master.Protein.Accessions', 'Master.Protein.Descriptions', contains("_5d") )

pY_mat_Batch2_by_cond_5d_noNA <- pY_Batch2_by_cond_5d_noNA %>% 
  mutate( rname = paste0( HGNC_Symbol, "_", Annotated_Sequence) ) %>%
  column_to_rownames("rname") %>%
  select(all_of( contains("Xenograft") )) %>%
  as.matrix() %>%
  t

rm(list=setdiff(ls(), c("pY_mat_Batch2_by_cond_noNA", "pY_Batch2_by_cond_noNA", 
                        "pY_mat_Batch1_by_cond_noNA", "pY_Batch1_by_cond_noNA", 
                        "pY_mat_Batch1_by_cond_5d_noNA", "pY_Batch1_by_cond_5d_noNA",
                        "pY_mat_Batch2_by_cond_5d_noNA", "pY_Batch2_by_cond_5d_noNA")  ))
```

## Load libraries and functions
```{r, echo=FALSE, warning=FALSE, message=FALSE}
set.seed(2022)
library(fgsea)
library(AnnotationDbi)
library(org.Hs.eg.db)
library(DEP)
library(SummarizedExperiment)
# library(pls)
library(mdatools)
source("../../../General/Code/Analysis_Functions.R")
source("CRC_Xenografts_Combined_Functions.R")
```

### StringDB
```{r}
string_db <- STRINGdb::STRINGdb$new( version="11.5", species=9606,
 score_threshold=400, input_directory="../../../General/Code/Data/")
```

### PhosphositePlus Databases
```{r}
kinase_substrate_dataset <- read_delim("../../../General/Code/Data/Kinase_Substrate_Dataset", delim = "\t", skip = 2) %>% filter(KIN_ORGANISM == "human")
kinase_substrate_dataset
Phosphorylation_site_dataset <- read_delim("../../../General/Code/Data/Phosphorylation_site_dataset", delim = "\t", skip = 2) %>% 
  filter(ORGANISM == "human")
Regulatory_sites_dataset <- read_delim("../../../General/Code/Data/Regulatory_sites", delim = "\t", skip = 2) %>% 
  filter(ORGANISM == "human") %>%
  filter(str_detect( MOD_RSD, "p") )
```

### PTMsigDB
```{r}
PtmSigdb <- readxl::read_excel("../../../General/Code/Data/db_ptm.sig.db.all.v2.0.0/data_PTMsigDB_all_sites_v2.0.0.xlsx")
```

## Combine batch 1 and batch 2
### All
```{r}
all_pY_peptides_form <- rbind( (pY_Batch1_by_cond_noNA %>% select('Annotated_Sequence', 'HGNC_Symbol', 'Master.Protein.Accessions', 'Master.Protein.Descriptions') ), 
(pY_Batch2_by_cond_noNA %>% select('Annotated_Sequence', 'HGNC_Symbol', 'Master.Protein.Accessions', 'Master.Protein.Descriptions') ) ) %>%
  unique


pY_all_xeno_form <- plyr::join_all(list(all_pY_peptides_form, pY_Batch1_by_cond_noNA,
                    pY_Batch2_by_cond_noNA), 
               by=c('Annotated_Sequence', 'HGNC_Symbol', 'Master.Protein.Accessions', 'Master.Protein.Descriptions' ), 
               type='left') %>% as_tibble() 

sum((is.na(pY_all_xeno_form ) %>% rowSums() ) ==0 ) 

pY_all_xeno_noNA <- pY_all_xeno_form %>% .[( (is.na(pY_all_xeno_form ) %>% rowSums() ) ==0),]

pY_mat_all_xeno_noNA <- pY_all_xeno_noNA %>% 
  mutate( rname = paste0( HGNC_Symbol, "_", Annotated_Sequence) ) %>%
  column_to_rownames("rname") %>%
  select(all_of( contains("Xenograft") )) %>%
  as.matrix() %>%
  t
```

### Day 5
```{r}
all_pY_peptides_5d_form <- rbind( (pY_Batch1_by_cond_5d_noNA %>% select('Annotated_Sequence', 'HGNC_Symbol', 'Master.Protein.Accessions', 'Master.Protein.Descriptions') ), 
(pY_Batch2_by_cond_5d_noNA %>% select('Annotated_Sequence', 'HGNC_Symbol', 'Master.Protein.Accessions', 'Master.Protein.Descriptions') ) ) %>%
  unique


pY_all_xeno_5d_form <- plyr::join_all(list(all_pY_peptides_5d_form, pY_Batch1_by_cond_5d_noNA,
                    pY_Batch2_by_cond_5d_noNA), 
               by=c('Annotated_Sequence', 'HGNC_Symbol', 'Master.Protein.Accessions', 'Master.Protein.Descriptions' ), 
               type='left') %>% as_tibble() 

sum((is.na(pY_all_xeno_5d_form ) %>% rowSums() ) ==0 ) 

pY_all_xeno_5d_noNA <- pY_all_xeno_5d_form %>% .[( (is.na(pY_all_xeno_5d_form ) %>% rowSums() ) ==0),]

pY_mat_all_xeno_5d_noNA <- pY_all_xeno_5d_noNA %>% 
  mutate( rname = paste0( HGNC_Symbol, "_", Annotated_Sequence) ) %>%
  column_to_rownames("rname") %>%
  select(all_of( contains("Xenograft") )) %>%
  as.matrix() %>%
  t
```

## Summarised Experiment
#### pY all
```{r}
# Assay data
assay_data_pY_all <- 
  pY_all_xeno_noNA %>% 
  mutate(coln = paste0(HGNC_Symbol, "_", Annotated_Sequence)) %>%
  as.data.frame() %>% 
  column_to_rownames("coln") %>%
  select( -Annotated_Sequence, -HGNC_Symbol, 
         -Master.Protein.Descriptions, -Master.Protein.Accessions) %>%
  as.matrix()

# RowData
rowData_pY_all <- 
  pY_all_xeno_noNA %>%
  select(Annotated_Sequence, HGNC_Symbol, Master.Protein.Descriptions, Master.Protein.Accessions) %>%
  mutate(coln = paste0(HGNC_Symbol, "_", Annotated_Sequence)) %>%
  mutate(ID = paste0(HGNC_Symbol, "_", Annotated_Sequence), 
         name = paste0(HGNC_Symbol, "_", Annotated_Sequence)) %>%
  as.data.frame() %>% 
  column_to_rownames("coln")


# ColData
colData_pY_all <- 
  str_split(colnames(assay_data_pY_all #) 
                  ), pattern = "_", simplify = TRUE ) %>%
  as.data.frame()
rownames(colData_pY_all) <-  colnames(assay_data_pY_all)
colnames(colData_pY_all) <- c( "replicate", "condition", "day")
colData_pY_all$label <- colnames(assay_data_pY_all)
colData_pY_all$ID <- colnames(assay_data_pY_all) 

pY_all_se <- SummarizedExperiment(assays = assay_data_pY_all,
                           colData = colData_pY_all,
                           rowData = rowData_pY_all)
validObject(pY_all_se)
pY_all_se
```

#### pY 5 day
```{r}
# Assay data
assay_data_pY_5d <- 
  pY_all_xeno_5d_noNA %>% 
  mutate(coln = paste0(HGNC_Symbol, "_", Annotated_Sequence)) %>%
  as.data.frame() %>% 
  column_to_rownames("coln") %>%
  select( -Annotated_Sequence, -HGNC_Symbol, 
         -Master.Protein.Descriptions, -Master.Protein.Accessions) %>%
  as.matrix()

# RowData
rowData_pY_5d <- 
  pY_all_xeno_5d_noNA %>%
  select(Annotated_Sequence, HGNC_Symbol, Master.Protein.Descriptions, Master.Protein.Accessions) %>%
  mutate(coln = paste0(HGNC_Symbol, "_", Annotated_Sequence)) %>%
  mutate(ID = paste0(HGNC_Symbol, "_", Annotated_Sequence), 
         name = paste0(HGNC_Symbol, "_", Annotated_Sequence)) %>%
  as.data.frame() %>% 
  column_to_rownames("coln")


# ColData
colData_pY_5d <- 
  str_split(colnames(assay_data_pY_5d #) 
                  ), pattern = "_", simplify = TRUE ) %>%
  as.data.frame()
rownames(colData_pY_5d) <-  colnames(assay_data_pY_5d)
colnames(colData_pY_5d) <- c( "replicate", "condition", "day")
colData_pY_5d$label <- colnames(assay_data_pY_5d)
colData_pY_5d$ID <- colnames(assay_data_pY_5d) 

pY_5d_se <- SummarizedExperiment(assays = assay_data_pY_5d,
                           colData = colData_pY_5d,
                           rowData = rowData_pY_5d)
validObject(pY_5d_se)
pY_5d_se
```

## Annotate phosphorylation sites
### pY
```{r}
# TODO How to deal with peptides which have multiple phosphorylations?


Annotate_pY_sites <- function(all_pY_sites){
  if(!all(str_count(all_pY_sites$Annotated_Sequence, "y") == 1)){warning("There are peptides with multiple pY sites")}
  tmp_sequence <- paste0("jjjjjjj", all_pY_sites$Annotated_Sequence,"jjjjjjj" )
  position_pY_phos <- str_locate(tmp_sequence, "y")[,1]
  tmp_sequence <- str_sub(tmp_sequence, (position_pY_phos-7), position_pY_phos + 7)
  tmp_sequence <- paste0( str_to_upper(str_sub(tmp_sequence,1,7 )), 
                                    str_to_lower(str_sub(tmp_sequence,8,8 )),
                                    str_to_upper(str_sub(tmp_sequence,9,15 )))
  tmp_sequence <- str_replace_all(string = tmp_sequence, pattern ="J", replacement = "")
  all_pY_sites$Modified_Sequence <- tmp_sequence
  Phosphorylation_site_dataset_pY <- 
    Phosphorylation_site_dataset %>% filter(GENE %in% all_pY_sites$HGNC_Symbol) %>%
    filter(!str_detect(PROTEIN, "iso")) %>%
    filter( str_detect( `SITE_+/-7_AA`, "y" ) ) %>% 
    mutate(Modified_Sequence = paste0( str_to_upper(str_sub(`SITE_+/-7_AA`,1,7 )), 
                                    str_to_lower(str_sub(`SITE_+/-7_AA`,8,8 )),
                                    str_to_upper(str_sub(`SITE_+/-7_AA`,9,16 ))) ) %>% 
    select(GENE, PROTEIN, HU_CHR_LOC, MOD_RSD, SITE_GRP_ID, DOMAIN, Modified_Sequence) %>%
    unique()
  
  Return_MOD_RSD <- function(HGNC_Symbol, Modified_Sequence){
    selprot <- Phosphorylation_site_dataset_pY %>% filter(GENE == HGNC_Symbol)
    if(length(str_which(selprot$Modified_Sequence, Modified_Sequence))==1){
    selsite <- selprot[ str_which(selprot$Modified_Sequence, Modified_Sequence), ]
    return(selsite$MOD_RSD)}else{return("NA")}
  }
  
  Return_DOMAIN <- function(HGNC_Symbol, Modified_Sequence){
    selprot <- Phosphorylation_site_dataset_pY %>% filter(GENE == HGNC_Symbol)
    if(length(str_which(selprot$Modified_Sequence, Modified_Sequence))==1){
    selsite <- selprot[ str_which(selprot$Modified_Sequence, Modified_Sequence), ]
    return(selsite$DOMAIN)}else{return("NA")}
  }
  
  Return_SITE_GRP_ID <- function(HGNC_Symbol, Modified_Sequence){
    selprot <- Phosphorylation_site_dataset_pY %>% filter(GENE == HGNC_Symbol)
    if(length(str_which(selprot$Modified_Sequence, Modified_Sequence))==1){
    selsite <- selprot[ str_which(selprot$Modified_Sequence, Modified_Sequence), ]
    return(selsite$SITE_GRP_ID)}else{return("NA")}
  }
  
  all_pY_sites$DOMAIN <- apply(all_pY_sites,1, function(x){ Return_DOMAIN(x[1], x[3] )}  )
  all_pY_sites$MOD_RSD <- apply(all_pY_sites,1, function(x){ Return_MOD_RSD(x[1], x[3] )}  )
  all_pY_sites$SITE_GRP_ID <- as.double( apply(all_pY_sites,1, function(x){ Return_SITE_GRP_ID(x[1], x[3] )}  ) )
  
  return(all_pY_sites)
  #all_pY_sites <- left_join(all_pY_sites,
  #          kinase_substrate_dataset %>% select(GENE, KINASE, SUBSTRATE, SUB_GENE, SUB_MOD_RSD, SITE_GRP_ID),
  #          by= "SITE_GRP_ID")
  #
  #all_pY_sites <- left_join(all_pY_sites, 
  #          Regulatory_sites_dataset %>% filter(GENE %in% unique(all_pY_sites$HGNC_Symbol), str_detect(MOD_RSD, "Y") ) , 
  #          by = c( "HGNC_Symbol" = "GENE", "MOD_RSD" )) 
}

all_pY_sites <- bind_rows(
  pY_all_xeno_noNA %>% select(HGNC_Symbol, Annotated_Sequence),
  pY_all_xeno_5d_noNA %>% select(HGNC_Symbol, Annotated_Sequence)) %>% unique

all_pY_sites <- Annotate_pY_sites(all_pY_sites)


```


# Quality control
## Nr. phospho sites
```{r}
print( paste( sum((is.na(pY_Batch1_by_cond_noNA) %>% rowSums() ) ==0 ) , "pY peptides passed the filtering procedure for the sets combined and the values are summed accross conditions" ))
print( paste( sum((is.na(pY_Batch2_by_cond_noNA) %>% rowSums() ) ==0 ) , "pY peptides passed the filtering procedure for the sets combined when Xenograft14_EC_24h is filtered out and the values are summed accross conditions" ))
print( paste( sum((is.na(pY_all_xeno_noNA) %>% rowSums() ) ==0 ) , "pY peptides passed the filtering procedure for the batches combined" ))
print( paste( sum((is.na(pY_all_xeno_5d_noNA) %>% rowSums() ) ==0 ) , "pY peptides passed the filtering procedure for the batches combined" ))
```

## Principle component analysis
### Phosphotyrosines all
```{r, fig.width=3, fig.height=3}
pY_mat_all_xeno_noNA %>%
  prcomp() %>% 
  summary() %>% 
  .$importance %>% t() %>% as.data.frame() %>%
  rownames_to_column("PC") %>% 
  as_tibble() %>%
  mutate(PC = as.factor(PC)) %>%
  mutate(PC = factor(PC, levels = PC)) %>%
  ggplot(aes(PC, `Proportion of Variance` )) +
  geom_point() +
  theme(axis.text.x = element_text(angle = 90))
```

```{r, fig.width=9, fig.height=3}
PCA_pY <- pY_mat_all_xeno_noNA %>%
  prcomp() %>% 
  .$x %>% 
  as.data.frame() %>%
  rownames_to_column("sample")

PCApY_rot <- pY_mat_all_xeno_noNA %>%
  prcomp() %>%
  .$rotation
PCApY_rot <- bind_cols(PCApY_rot, 
  (pY_all_xeno_noNA %>% select(HGNC_Symbol, Annotated_Sequence) ) ) %>% arrange(desc(PC1) )

PCA_pY <- PCA_pY %>% 
  mutate(sample= str_remove(sample,"Xenograft")) %>%
  separate( sample , into = c("xenograft", "treatment", "day"), sep = "_")

PCA12_pY <- PCA_pY %>% 
  ggplot(aes(PC1, PC2, color = treatment, shape = day )) +
  geom_point(size = 3) +
  theme_classic() +
  scale_colour_manual(values=PGPalette[c(5,1,4,2)]) +
  geom_text(aes(label = xenograft), color = "black", nudge_x = 1) +
  ggtitle("pY")

PCA34_pY <- PCA_pY %>% 
  ggplot(aes(PC3, PC4, color = treatment, shape = day )) +
  geom_point(size = 3) +
  theme_classic() +
  scale_colour_manual(values=PGPalette[c(5,1,4,2)]) +
  geom_text(aes(label = xenograft), color = "black", nudge_x = 1) +
  ggtitle("pY")

ggpubr::ggarrange(PCA12_pY, PCA34_pY)

PCA12_pY <- PCA_pY %>% 
  ggplot(aes(PC1, PC2, color = day, shape = day )) +
  geom_point(size = 3) +
  theme_classic() +
  scale_colour_manual(values=PGPalette[c(5,1,4,2)]) +
  geom_text(aes(label = xenograft), color = "black", nudge_x = 1) +
  ggtitle("pY")

PCA34_pY <- PCA_pY %>% 
  ggplot(aes(PC3, PC4, color = day, shape = day )) +
  geom_point(size = 3) +
  theme_classic() +
  scale_colour_manual(values=PGPalette[c(5,1,4,2)]) +
  geom_text(aes(label = xenograft), color = "black", nudge_x = 1) +
  ggtitle("pY")

ggpubr::ggarrange(PCA12_pY, PCA34_pY)

PCA12_pY <- PCA_pY %>% 
  ggplot(aes(PC1, PC2, color = xenograft, shape = day )) +
  geom_point(size = 3) +
  theme_classic() +
  scale_colour_manual(values=PGPalette[c(5,1,4,2)]) +
  geom_text(aes(label = xenograft), color = "black", nudge_x = 1) +
  ggtitle("pY")

PCA34_pY <- PCA_pY %>% 
  ggplot(aes(PC3, PC4, color = xenograft, shape = day )) +
  geom_point(size = 3) +
  theme_classic() +
  scale_colour_manual(values=PGPalette[c(5,1,4,2)]) +
  geom_text(aes(label = xenograft), color = "black", nudge_x = 1) +
  ggtitle("pY")

ggpubr::ggarrange(PCA12_pY, PCA34_pY)
```

### Phosphotyrosines 5 day dataframe
```{r, fig.width=3, fig.height=3}
pY_mat_all_xeno_5d_noNA %>%
  prcomp() %>% 
  summary() %>% 
  .$importance %>% t() %>% as.data.frame() %>%
  rownames_to_column("PC") %>% 
  as_tibble() %>%
  mutate(PC = as.factor(PC)) %>%
  mutate(PC = factor(PC, levels = PC)) %>%
  ggplot(aes(PC, `Proportion of Variance` )) +
  geom_point() +
  theme(axis.text.x = element_text(angle = 90))
```

```{r, fig.width=9, fig.height=3}
PCA_pY <- pY_mat_all_xeno_5d_noNA %>%
  prcomp() %>% 
  .$x %>% 
  as.data.frame() %>%
  rownames_to_column("sample")

PCApY_rot <- pY_mat_all_xeno_5d_noNA %>%
  prcomp() %>%
  .$rotation
PCApY_rot <- bind_cols(PCApY_rot, 
  (pY_all_xeno_5d_noNA %>% select(HGNC_Symbol, Annotated_Sequence) ) ) %>% arrange(desc(PC1) )

PCA_pY <- PCA_pY %>% 
  mutate(sample= str_remove(sample,"Xenograft")) %>%
  separate( sample , into = c("xenograft", "treatment", "day"), sep = "_")

PCA12_pY <- PCA_pY %>% 
  ggplot(aes(PC1, PC2, color = treatment, shape = day )) +
  geom_point(size = 3) +
  theme_classic() +
  scale_colour_manual(values=PGPalette[c(5,1,4,2)]) +
  geom_text(aes(label = xenograft), color = "black", nudge_x = 1) +
  ggtitle("pY")

PCA34_pY <- PCA_pY %>% 
  ggplot(aes(PC3, PC4, color = treatment, shape = day )) +
  geom_point(size = 3) +
  theme_classic() +
  scale_colour_manual(values=PGPalette[c(5,1,4,2)]) +
  geom_text(aes(label = xenograft), color = "black", nudge_x = 1) +
  ggtitle("pY")

ggpubr::ggarrange(PCA12_pY, PCA34_pY)

PCA12_pY <- PCA_pY %>% 
  ggplot(aes(PC1, PC2, color = day, shape = day )) +
  geom_point(size = 3) +
  theme_classic() +
  scale_colour_manual(values=PGPalette[c(5,1,4,2)]) +
  geom_text(aes(label = xenograft), color = "black", nudge_x = 1) +
  ggtitle("pY")

PCA34_pY <- PCA_pY %>% 
  ggplot(aes(PC3, PC4, color = day, shape = day )) +
  geom_point(size = 3) +
  theme_classic() +
  scale_colour_manual(values=PGPalette[c(5,1,4,2)]) +
  geom_text(aes(label = xenograft), color = "black", nudge_x = 1) +
  ggtitle("pY")

ggpubr::ggarrange(PCA12_pY, PCA34_pY)

PCA12_pY <- PCA_pY %>% 
  ggplot(aes(PC1, PC2, color = xenograft, shape = day )) +
  geom_point(size = 3) +
  theme_classic() +
  scale_colour_manual(values=PGPalette[c(5,1,4,2)]) +
  geom_text(aes(label = xenograft), color = "black", nudge_x = 1) +
  ggtitle("pY")

PCA34_pY <- PCA_pY %>% 
  ggplot(aes(PC3, PC4, color = xenograft, shape = day )) +
  geom_point(size = 3) +
  theme_classic() +
  scale_colour_manual(values=PGPalette[c(5,1,4,2)]) +
  geom_text(aes(label = xenograft), color = "black", nudge_x = 1) +
  ggtitle("pY")

ggpubr::ggarrange(PCA12_pY, PCA34_pY)
```


# Analysis

## DEP
### Tyrosine all
#### E vs ctrl
```{r, eval=TRUE}
data_diff_E_vs_ctrl_pY <- test_diff(pY_all_se, type="manual", test = "E_vs_ctrl")
dep_E_vs_ctrl_pY <- add_rejections_SH(data_diff_E_vs_ctrl_pY, alpha = 0.05, lfc = log2(1.2))
GGPlotly_Volcano(dep_E_vs_ctrl_pY, contrast = "E_vs_ctrl", 
                 add_names = TRUE,
                additional_title = "pY") 
```

```{r, fig.width=10, fig.height=10}
Return_DEP_Hits_Plots(data = pY_all_xeno_form, dep_E_vs_ctrl_pY, comparison = "E_vs_ctrl_diff")
```

##### Reactome GSEA
```{r}
GSEA_E_vs_ctrl <- Run_GSEA(DEP_result = dep_E_vs_ctrl_pY, comparison = "E_vs_ctrl_diff", return_df = T)
GSEA_E_vs_ctrl %>% as_tibble() %>% filter(padj < 0.05) %>% arrange(desc(NES))
```

##### PTM-SEA
###### All types
```{r}
GSEA_E_vs_ctrl_PTM <- Run_GSEA(DEP_result = dep_E_vs_ctrl_pY, comparison = "E_vs_ctrl_diff", return_df = T,
         ptmGSEA_site_df = all_pY_sites, PtmSigdb = PtmSigdb, ptmGSEA = T)
GSEA_E_vs_ctrl_PTM %>% as_tibble() %>% filter(padj < 0.05) %>% arrange(desc(NES))
GSEA_E_vs_ctrl_PTM %>% as_tibble() %>% filter(pathway == "PATH-NP_EGFR1_PATHWAY")
Run_GSEA(DEP_result = dep_E_vs_ctrl_pY, comparison = "E_vs_ctrl_diff", return_df = T,
         ptmGSEA_site_df = all_pY_sites, PtmSigdb = PtmSigdb, ptmGSEA = T, single_pathway = "PATH-NP_EGFR1_PATHWAY")
Run_GSEA(DEP_result = dep_E_vs_ctrl_pY, comparison = "E_vs_ctrl_diff", return_df = T,
         ptmGSEA_site_df = all_pY_sites, PtmSigdb = PtmSigdb, ptmGSEA = T, single_pathway = "KINASE-PSP_Src/SRC")
```

###### Only pathways
```{r}
GSEA_E_vs_ctrl_PTM_path <- Run_GSEA(DEP_result = dep_E_vs_ctrl_pY, comparison = "E_vs_ctrl_diff", return_df = T,
         ptmGSEA_site_df = all_pY_sites, 
         PtmSigdb = PtmSigdb %>% filter(str_detect(signature, "^PATH" ) ), 
         ptmGSEA = T)
GSEA_E_vs_ctrl_PTM_path %>% as_tibble() %>% filter(padj < 0.05) %>% arrange(desc(NES))
GSEA_E_vs_ctrl_PTM_path %>% as_tibble() %>% filter(pathway == "PATH-NP_EGFR1_PATHWAY")

```

###### Only kinases
```{r}
GSEA_E_vs_ctrl_PTM_kinase <- Run_GSEA(DEP_result = dep_E_vs_ctrl_pY, comparison = "E_vs_ctrl_diff", return_df = T,
         ptmGSEA_site_df = all_pY_sites, 
         PtmSigdb = PtmSigdb %>% filter(str_detect(signature, "^KINASE" ) ), 
         ptmGSEA = T)
GSEA_E_vs_ctrl_PTM_kinase %>% as_tibble() %>% filter(padj < 0.05) %>% arrange(desc(NES))
GSEA_E_vs_ctrl_PTM_kinase %>% as_tibble() %>% arrange(desc(NES))
```

#### EC vs ctrl
```{r}
data_diff_EC_vs_ctrl_pY <- test_diff(pY_all_se, type="manual", test = "EC_vs_ctrl")
dep_EC_vs_ctrl_pY <- add_rejections_SH(data_diff_EC_vs_ctrl_pY, alpha = 0.05, lfc = log2(1.2))
GGPlotly_Volcano(dep_EC_vs_ctrl_pY, contrast = "EC_vs_ctrl", 
                 add_names = TRUE,
                additional_title = "pY") 
```

```{r, fig.width=10, fig.height=10}
Return_DEP_Hits_Plots(data = pY_all_xeno_form, dep_EC_vs_ctrl_pY, comparison = "EC_vs_ctrl_diff")
```

##### Reactome GSEA
```{r}
GSEA_EC_vs_ctrl <- Run_GSEA(DEP_result = dep_EC_vs_ctrl_pY, comparison = "EC_vs_ctrl_diff", return_df = T)
GSEA_EC_vs_ctrl %>% as_tibble() %>% filter(padj < 0.05) %>% arrange(desc(NES))
```

##### PTM-SEA
```{r}
GSEA_EC_vs_ctrl_PTM <- Run_GSEA(DEP_result = dep_EC_vs_ctrl_pY, comparison = "EC_vs_ctrl_diff", return_df = T,
         ptmGSEA_site_df = all_pY_sites, PtmSigdb = PtmSigdb, ptmGSEA = T)
GSEA_EC_vs_ctrl_PTM %>% as_tibble() %>% filter(padj < 0.05) %>% arrange(desc(NES))
Run_GSEA(DEP_result = dep_EC_vs_ctrl_pY, comparison = "EC_vs_ctrl_diff", return_df = T,
         ptmGSEA_site_df = all_pY_sites, PtmSigdb = PtmSigdb, ptmGSEA = T, single_pathway = "PATH-NP_EGFR1_PATHWAY")
Run_GSEA(DEP_result = dep_EC_vs_ctrl_pY, comparison = "EC_vs_ctrl_diff", return_df = T,
         ptmGSEA_site_df = all_pY_sites, PtmSigdb = PtmSigdb, ptmGSEA = T, single_pathway = "KINASE-PSP_Src/SRC")

```

###### Only kinases
```{r}
GSEA_EC_vs_ctrl_PTM_kinase <- Run_GSEA(DEP_result = dep_EC_vs_ctrl_pY, comparison = "EC_vs_ctrl_diff", return_df = T,
         ptmGSEA_site_df = all_pY_sites, 
         PtmSigdb = PtmSigdb %>% filter(str_detect(signature, "^KINASE" ) ), 
         ptmGSEA = T)
GSEA_EC_vs_ctrl_PTM_kinase %>% as_tibble() %>% filter(padj < 0.05) %>% arrange(desc(NES))
GSEA_EC_vs_ctrl_PTM_kinase %>% as_tibble() %>% arrange(desc(NES))
```

#### EBC vs ctrl

```{r}
data_diff_EBC_vs_ctrl_pY <- test_diff(pY_all_se, type="manual", test = "EBC_vs_ctrl")
dep_EBC_vs_ctrl_pY <- add_rejections_SH(data_diff_EBC_vs_ctrl_pY, alpha = 0.05, lfc = log2(1.2))
GGPlotly_Volcano(dep_EBC_vs_ctrl_pY, contrast = "EBC_vs_ctrl", 
                 add_names = TRUE,
                additional_title = "pY")
```

```{r, fig.width=10, fig.height=10}
Return_DEP_Hits_Plots(data = pY_all_xeno_form, dep_EBC_vs_ctrl_pY, comparison = "EBC_vs_ctrl_diff")
```

##### Reactome GSEA
```{r}
GSEA_EBC_vs_ctrl <- Run_GSEA(DEP_result = dep_EBC_vs_ctrl_pY, comparison = "EBC_vs_ctrl_diff", return_df = T)
GSEA_EBC_vs_ctrl %>% as_tibble() %>% filter(padj < 0.05) %>% arrange(desc(NES))
```

##### PTM-SEA
```{r}
GSEA_EBC_vs_ctrl_PTM <- Run_GSEA(DEP_result = dep_EBC_vs_ctrl_pY, comparison = "EBC_vs_ctrl_diff", return_df = T,
         ptmGSEA_site_df = all_pY_sites, PtmSigdb = PtmSigdb, ptmGSEA = T)
GSEA_EBC_vs_ctrl_PTM %>% as_tibble() %>% filter(padj < 0.05) %>% arrange(desc(NES))
Run_GSEA(DEP_result = dep_EBC_vs_ctrl_pY, comparison = "EBC_vs_ctrl_diff", return_df = T,
         ptmGSEA_site_df = all_pY_sites, PtmSigdb = PtmSigdb, ptmGSEA = T, single_pathway = "PATH-NP_EGFR1_PATHWAY")
Run_GSEA(DEP_result = dep_EBC_vs_ctrl_pY, comparison = "EBC_vs_ctrl_diff", return_df = T,
         ptmGSEA_site_df = all_pY_sites, PtmSigdb = PtmSigdb, ptmGSEA = T, single_pathway = "KINASE-PSP_Src/SRC")

```

#### EC vs E
```{r}
data_diff_EC_vs_E_pY <- test_diff(pY_all_se, type = "manual", 
                              test = c("EC_vs_E"))
dep_EC_vs_E_pY <- add_rejections_SH(data_diff_EC_vs_E_pY, alpha = 0.05, lfc = log2(1.2))
GGPlotly_Volcano(dep_EC_vs_E_pY, contrast = "EC_vs_E",  add_names = TRUE, additional_title = "pY", proteins_of_interest = "EGFR")
```

```{r, fig.width=10, fig.height=10}
Return_DEP_Hits_Plots(data = pY_all_xeno_form, dep_EC_vs_E_pY, comparison = "EC_vs_E_diff")

#data_results <- get_df_long(dep)
```

##### Reactome GSEA
```{r}
GSEA_EC_vs_E <- Run_GSEA(DEP_result = dep_EC_vs_E_pY, comparison = "EC_vs_E_diff", return_df = T)
GSEA_EC_vs_E %>% as_tibble() %>% filter(padj < 0.05) %>% arrange(desc(NES))
```

##### PTM-SEA
```{r}
GSEA_EC_vs_E_PTM <- Run_GSEA(DEP_result = dep_EC_vs_E_pY, comparison = "EC_vs_E_diff", return_df = T,
         ptmGSEA_site_df = all_pY_sites, PtmSigdb = PtmSigdb, ptmGSEA = T)
GSEA_EC_vs_E_PTM %>% as_tibble() %>% filter(padj < 0.05) %>% arrange(desc(NES))
GSEA_EC_vs_E_PTM %>% as_tibble() %>% filter(pathway == "PATH-NP_EGFR1_PATHWAY")
Run_GSEA(DEP_result = dep_EC_vs_E_pY, comparison = "EC_vs_E_diff", return_df = T,
         ptmGSEA_site_df = all_pY_sites, PtmSigdb = PtmSigdb, ptmGSEA = T, single_pathway = "PATH-NP_EGFR1_PATHWAY")
Run_GSEA(DEP_result = dep_EC_vs_E_pY, comparison = "EC_vs_E_diff", return_df = T,
         ptmGSEA_site_df = all_pY_sites, PtmSigdb = PtmSigdb, ptmGSEA = T, single_pathway = "KINASE-PSP_Src/SRC")
```

#### EBC vs EC
```{r}
data_diff_EBC_vs_EC_pY <- test_diff(pY_all_se, type = "manual", 
                              test = c("EBC_vs_EC"))
dep_EBC_vs_EC_pY <- add_rejections_SH(data_diff_EBC_vs_EC_pY, alpha = 0.05, lfc = log2(1.2))
GGPlotly_Volcano(dep_EBC_vs_EC_pY, contrast = "EBC_vs_EC",  add_names = TRUE, additional_title = "pY")
```

```{r, fig.width=10, fig.height=10}
Return_DEP_Hits_Plots(data = pY_all_xeno_form, dep_EBC_vs_EC_pY, comparison = "EBC_vs_EC_diff")

#data_results <- get_df_long(dep)
```

##### Reactome GSEA
```{r}
GSEA_EBC_vs_EC <- Run_GSEA(DEP_result = dep_EBC_vs_EC_pY, comparison = "EBC_vs_EC_diff", return_df = T)
GSEA_EBC_vs_EC %>% as_tibble() %>% filter(padj < 0.05) %>% arrange(desc(NES))
```

##### PTM-SEA
```{r}
GSEA_EBC_vs_EC_PTM <- Run_GSEA(DEP_result = dep_EBC_vs_EC_pY, comparison = "EBC_vs_EC_diff", return_df = T,
         ptmGSEA_site_df = all_pY_sites, PtmSigdb = PtmSigdb, ptmGSEA = T)
GSEA_EBC_vs_EC_PTM %>% as_tibble() %>% filter(padj < 0.05) %>% arrange(desc(NES))
GSEA_EBC_vs_EC_PTM %>% as_tibble() %>% filter(pathway == "PATH-NP_EGFR1_PATHWAY")
Run_GSEA(DEP_result = dep_EBC_vs_EC_pY, comparison = "EBC_vs_EC_diff", return_df = T,
         ptmGSEA_site_df = all_pY_sites, PtmSigdb = PtmSigdb, ptmGSEA = T, single_pathway = "PATH-NP_EGFR1_PATHWAY")
Run_GSEA(DEP_result = dep_EBC_vs_EC_pY, comparison = "EBC_vs_EC_diff", return_df = T,
         ptmGSEA_site_df = all_pY_sites, PtmSigdb = PtmSigdb, ptmGSEA = T, single_pathway = "KINASE-PSP_Src/SRC")

```

### Tyrosine 5 day dataframe
#### E vs ctrl
```{r, eval=TRUE}
data_diff_E_vs_ctrl_pY <- test_diff(pY_5d_se, type="manual", test = "E_vs_ctrl")
dep_E_vs_ctrl_pY <- add_rejections_SH(data_diff_E_vs_ctrl_pY, alpha = 0.05, lfc = log2(1.2))
GGPlotly_Volcano(dep_E_vs_ctrl_pY, contrast = "E_vs_ctrl", 
                 add_names = TRUE,
                additional_title = "pY") 
```

```{r, fig.width=10, fig.height=10}
Return_DEP_Hits_Plots(data = pY_all_xeno_5d_form, dep_E_vs_ctrl_pY, comparison = "E_vs_ctrl_diff")
```

##### Reactome GSEA
```{r}
GSEA_E_vs_ctrl <- Run_GSEA(DEP_result = dep_E_vs_ctrl_pY, comparison = "E_vs_ctrl_diff", return_df = T)
GSEA_E_vs_ctrl %>% as_tibble() %>% filter(padj < 0.05) %>% arrange(desc(NES))
```

##### PTM-SEA
```{r}
GSEA_E_vs_ctrl_PTM <- Run_GSEA(DEP_result = dep_E_vs_ctrl_pY, comparison = "E_vs_ctrl_diff", return_df = T,
         ptmGSEA_site_df = all_pY_sites, PtmSigdb = PtmSigdb, ptmGSEA = T)
GSEA_E_vs_ctrl_PTM %>% as_tibble() %>% filter(padj < 0.05) %>% arrange(desc(NES))
Run_GSEA(DEP_result = dep_E_vs_ctrl_pY, comparison = "E_vs_ctrl_diff", return_df = T,
         ptmGSEA_site_df = all_pY_sites, PtmSigdb = PtmSigdb, ptmGSEA = T, single_pathway = "PATH-NP_EGFR1_PATHWAY")
Run_GSEA(DEP_result = dep_E_vs_ctrl_pY, comparison = "E_vs_ctrl_diff", return_df = T,
         ptmGSEA_site_df = all_pY_sites, PtmSigdb = PtmSigdb, ptmGSEA = T, single_pathway = "PATH-NP_KIT_RECEPTOR_PATHWAY")
Run_GSEA(DEP_result = dep_E_vs_ctrl_pY, comparison = "E_vs_ctrl_diff", return_df = T,
         ptmGSEA_site_df = all_pY_sites, PtmSigdb = PtmSigdb, ptmGSEA = T, single_pathway = "KINASE-PSP_Src/SRC")

```

#### EC vs ctrl
```{r}
data_diff_EC_vs_ctrl_pY <- test_diff(pY_5d_se, type="manual", test = "EC_vs_ctrl")
dep_EC_vs_ctrl_pY <- add_rejections_SH(data_diff_EC_vs_ctrl_pY, alpha = 0.05, lfc = log2(1.2))
GGPlotly_Volcano(dep_EC_vs_ctrl_pY, contrast = "EC_vs_ctrl", 
                 add_names = TRUE,
                additional_title = "pY") 
```

```{r, fig.width=10, fig.height=10}
Return_DEP_Hits_Plots(data = pY_all_xeno_5d_form, dep_EC_vs_ctrl_pY, comparison = "EC_vs_ctrl_diff")
```


##### Reactome GSEA
```{r}
GSEA_EC_vs_ctrl <- Run_GSEA(DEP_result = dep_EC_vs_ctrl_pY, comparison = "EC_vs_ctrl_diff", return_df = T)
GSEA_EC_vs_ctrl %>% as_tibble() %>% filter(padj < 0.1) %>% arrange(desc(NES))
```

##### PTM-SEA
```{r}
GSEA_EC_vs_ctrl_PTM <- Run_GSEA(DEP_result = dep_EC_vs_ctrl_pY, comparison = "EC_vs_ctrl_diff", return_df = T,
         ptmGSEA_site_df = all_pY_sites, PtmSigdb = PtmSigdb, ptmGSEA = T)
GSEA_EC_vs_ctrl_PTM %>% as_tibble() %>% filter(padj < 0.1) %>% arrange(desc(NES))
Run_GSEA(DEP_result = dep_EC_vs_ctrl_pY, comparison = "EC_vs_ctrl_diff", return_df = T,
         ptmGSEA_site_df = all_pY_sites, PtmSigdb = PtmSigdb, ptmGSEA = T, single_pathway = "PATH-NP_EGFR1_PATHWAY")
Run_GSEA(DEP_result = dep_EC_vs_ctrl_pY, comparison = "EC_vs_ctrl_diff", return_df = T,
         ptmGSEA_site_df = all_pY_sites, PtmSigdb = PtmSigdb, ptmGSEA = T, single_pathway = "KINASE-PSP_Src/SRC")
```

#### EBC vs ctrl

```{r}
data_diff_EBC_vs_ctrl_pY <- test_diff(pY_5d_se, type="manual", test = "EBC_vs_ctrl")
dep_EBC_vs_ctrl_pY <- add_rejections_SH(data_diff_EBC_vs_ctrl_pY, alpha = 0.05, lfc = log2(1.2))
GGPlotly_Volcano(dep_EBC_vs_ctrl_pY, contrast = "EBC_vs_ctrl", 
                 add_names = TRUE,
                additional_title = "pY")
```

```{r, fig.width=10, fig.height=10}
Return_DEP_Hits_Plots(data = pY_all_xeno_5d_form, dep_EBC_vs_ctrl_pY, comparison = "EBC_vs_ctrl_diff")
```


##### Reactome GSEA
```{r}
GSEA_EBC_vs_ctrl <- Run_GSEA(DEP_result = dep_EBC_vs_ctrl_pY, comparison = "EBC_vs_ctrl_diff", return_df = T)
GSEA_EBC_vs_ctrl %>% as_tibble() %>% filter(padj < 0.05) %>% arrange(desc(NES))
```

##### PTM-SEA
```{r}
GSEA_EBC_vs_ctrl_PTM <- Run_GSEA(DEP_result = dep_EBC_vs_ctrl_pY, comparison = "EBC_vs_ctrl_diff", return_df = T,
         ptmGSEA_site_df = all_pY_sites, PtmSigdb = PtmSigdb, ptmGSEA = T)
GSEA_EBC_vs_ctrl_PTM %>% as_tibble() %>% filter(padj < 0.1) %>% arrange(desc(NES))
Run_GSEA(DEP_result = dep_EBC_vs_ctrl_pY, comparison = "EBC_vs_ctrl_diff", return_df = T,
         ptmGSEA_site_df = all_pY_sites, PtmSigdb = PtmSigdb, ptmGSEA = T, single_pathway = "PATH-NP_EGFR1_PATHWAY")
Run_GSEA(DEP_result = dep_EBC_vs_ctrl_pY, comparison = "EBC_vs_ctrl_diff", return_df = T,
         ptmGSEA_site_df = all_pY_sites, PtmSigdb = PtmSigdb, ptmGSEA = T, single_pathway = "KINASE-PSP_Src/SRC")
```

#### EC vs E
```{r}
data_diff_EC_vs_E_pY <- test_diff(pY_5d_se, type = "manual", 
                              test = c("EC_vs_E"))
dep_EC_vs_E_pY <- add_rejections_SH(data_diff_EC_vs_E_pY, alpha = 0.05, lfc = log2(1.2))
GGPlotly_Volcano(dep_EC_vs_E_pY, contrast = "EC_vs_E",  add_names = TRUE, additional_title = "pY", proteins_of_interest = "EGFR")
```

```{r, fig.width=10, fig.height=10}
Return_DEP_Hits_Plots(data = pY_all_xeno_5d_form, dep_EC_vs_E_pY, comparison = "EC_vs_E_diff")

#data_results <- get_df_long(dep)
```

##### Reactome GSEA
```{r}
GSEA_EC_vs_E <- Run_GSEA(DEP_result = dep_EC_vs_E_pY, comparison = "EC_vs_E_diff", return_df = T)
GSEA_EC_vs_E %>% as_tibble() %>% filter(padj < 0.05) %>% arrange(desc(NES))
```

##### PTM-SEA
```{r}
GSEA_EC_vs_E_PTM <- Run_GSEA(DEP_result = dep_EC_vs_E_pY, comparison = "EC_vs_E_diff", return_df = T,
         ptmGSEA_site_df = all_pY_sites, PtmSigdb = PtmSigdb, ptmGSEA = T)
GSEA_EC_vs_E_PTM %>% as_tibble() %>% filter(padj < 0.05) %>% arrange(desc(NES))
Run_GSEA(DEP_result = dep_EC_vs_E_pY, comparison = "EC_vs_E_diff", return_df = T,
         ptmGSEA_site_df = all_pY_sites, PtmSigdb = PtmSigdb, ptmGSEA = T, single_pathway = "PATH-NP_EGFR1_PATHWAY")
Run_GSEA(DEP_result = dep_EC_vs_E_pY, comparison = "EC_vs_E_diff", return_df = T,
         ptmGSEA_site_df = all_pY_sites, PtmSigdb = PtmSigdb, ptmGSEA = T, single_pathway = "KINASE-PSP_Src/SRC")
```

#### EBC vs EC
```{r}
data_diff_EBC_vs_EC_pY <- test_diff(pY_5d_se, type = "manual", 
                              test = c("EBC_vs_EC"))
dep_EBC_vs_EC_pY <- add_rejections_SH(data_diff_EBC_vs_EC_pY, alpha = 0.05, lfc = log2(1.2))
GGPlotly_Volcano(dep_EBC_vs_EC_pY, contrast = "EBC_vs_EC",  add_names = TRUE, additional_title = "pY")
```

```{r, fig.width=10, fig.height=10}
Return_DEP_Hits_Plots(data = pY_all_xeno_5d_form, dep_EBC_vs_EC_pY, comparison = "EBC_vs_EC_diff")

#data_results <- get_df_long(dep)
```

##### Reactome GSEA
```{r}
GSEA_EBC_vs_EC <- Run_GSEA(DEP_result = dep_EBC_vs_EC_pY, comparison = "EBC_vs_EC_diff", return_df = T)
GSEA_EBC_vs_EC %>% as_tibble() %>% filter(padj < 0.05) %>% arrange(desc(NES))
```

##### PTM-SEA
```{r}
GSEA_EBC_vs_EC_PTM <- Run_GSEA(DEP_result = dep_EBC_vs_EC_pY, comparison = "EBC_vs_EC_diff", return_df = T,
         ptmGSEA_site_df = all_pY_sites, PtmSigdb = PtmSigdb, ptmGSEA = T)
GSEA_EBC_vs_EC_PTM %>% as_tibble() %>% filter(padj < 0.05) %>% arrange(desc(NES))
Run_GSEA(DEP_result = dep_EBC_vs_EC_pY, comparison = "EBC_vs_EC_diff", return_df = T,
         ptmGSEA_site_df = all_pY_sites, PtmSigdb = PtmSigdb, ptmGSEA = T, single_pathway = "PATH-NP_EGFR1_PATHWAY")
Run_GSEA(DEP_result = dep_EBC_vs_EC_pY, comparison = "EBC_vs_EC_diff", return_df = T,
         ptmGSEA_site_df = all_pY_sites, PtmSigdb = PtmSigdb, ptmGSEA = T, single_pathway = "KINASE-PSP_Src/SRC")

```

# Session Info
```{r}
sessionInfo()
knitr::knit_exit()
```
