---
title: "SOMs (mediancentered) - DIPG Batch 1"
author: Sophie Herbst
output:
  html_document:
    code_folding: hide
    toc: yes
    toc_depth: 5
    toc_float: yes
editor_options: 
  chunk_output_type: console
---
Analysis date: `r Sys.Date()`

# Depends on
DIPG_FirstBatch_DataProcessing Script

```{r}
#set.seed(2022)
load("../Data/Cache/DIPG_FirstBatch_DataProcessingMissingValues40.RData")
```

# Setup
## Load libraries
```{r, echo=FALSE, warning=FALSE, message=FALSE}
set.seed(2022)
library(fgsea)
library(AnnotationDbi)
library(org.Hs.eg.db)
library(DEP)
library(SummarizedExperiment)
# library(pls)
library(mdatools)
library(kohonen) # SOMs package
```

## Functions
### General
```{r}
source("../../../General/Code/Analysis_Functions.R")
source("DIPG_FirstBatch_Functions.R")
```

### SOMs
```{r}
Train_SOM <- function(phos_mat, try.k){
  ## define a grid for the SOM and train
  grid.size <- ceiling(nrow(phos_mat ) ^ (1/2.5))
  som.grid <- somgrid(xdim = grid.size, ydim = grid.size, topo =   'hexagonal', toroidal = T)
  som.model <- som(data.matrix(phos_mat ), grid = som.grid)
  
  ## extract some data to make it easier to use
  som.events <- som.model$codes[[1]]
  #som.events.colors <- rgb(som.events[,1], som.events[,2],   som.events[,3], maxColorValue = 255)
  som.dist <- as.matrix(dist(som.events))
  
  
  plot(som.model, type = 'mapping', cex=0.2)
  plot(som.model, type="changes")
  plot(som.model, type = 'count')
  plot(som.model, type="dist.neighbours")
  # plot(som.model, type="codes") 
  # dev.off()
  #plot(som.model, type = "property", property = som.model$codes[,4],   main=names(som.model$data)[4]#, palette.name=coolBlueHotRed
  
  #try.k <- 2:100
  cluster.dist.eval <- as.data.frame(matrix(ncol = 3, nrow = (length(try.k))))
  colnames(cluster.dist.eval) <- c('k', 'kmeans', 'hclust')
  
  for(i in 1:length(try.k)) {
    cluster.dist.eval[i, 'k'] <- try.k[i]
    cluster.dist.eval[i, 'kmeans'] <- Cluster_Mean_Dist(kmeans(som.events, centers   = try.k[i], iter.max = 20)$cluster, som.dist = som.dist)
    cluster.dist.eval[i, 'hclust'] <-   Cluster_Mean_Dist(cutree(hclust(vegan::vegdist(som.events)), k = try.k[i]),   som.dist = som.dist)
  }
  
  plot(cluster.dist.eval[, 'kmeans'] ~ try.k,
       type = 'l')
  
  lines(cluster.dist.eval[, 'hclust'] ~ try.k,
        col = 'red')
  
  legend('topright',
         legend = c('k-means', 'hierarchical'),
         col = c('black', 'red'),
         lty = c(1, 1))
  
  return(list( som.model, som.events ))
}

## Define a function to calculate mean distance within each cluster.  This
## is roughly analogous to the within clusters ss approach
Cluster_Mean_Dist <- function(clusters, som.dist){
  cluster.means = c()
  
  for(c in unique(clusters)){
    temp.members <- which(clusters == c)
    
    if(length(temp.members) > 1){
      temp.dist <- som.dist[temp.members,]
      temp.dist <- temp.dist[,temp.members]
      cluster.means <- append(cluster.means, mean(temp.dist))
    }else(cluster.means <- 0)
  }
  
  return(mean(cluster.means))
  
}

Plot_Colored_SOM <- function(som.model, clusters, type = "mapping", cl = 40){
  plot(som.model, 
       type = type, 
       pchs = 21, 
       cex=0.2,
       col = "black",
       #bg = c("blue" , "red", "yellow", "green")[as.factor(str_remove(str_split( rownames(som.model$data[[1]]), "-", simplify = T )[,1], "log2FC_")) ] , 
       keepMargins = F,
       bgcol = c(RColorBrewer::brewer.pal(12, "Set3"), RColorBrewer::brewer.pal(9, "Set1"), RColorBrewer::brewer.pal(8, "Set2"), RColorBrewer::brewer.pal(9, "Pastel1"), RColorBrewer::brewer.pal(8, "Dark2"))[clusters]  )
  
    add.cluster.boundaries(som.model, clusters)
}

Asign_To_Clusters <- function(som.model, clusters){
  cluster_classification <- som.model$unit.classif
  names(cluster_classification) <- rownames(som.model$data[[1]])
  classification <- clusters[cluster_classification]
  names(classification) <- rownames(som.model$data[[1]])
  classification
}

Get_Members_Of_One_Cluster <- function(som.model, clusters, n){
  message(paste("Cluster" , n ))
  asign <- Asign_To_Clusters(som.model, clusters)
  names(asign[asign == n])
}

Get_Mat_With_Assigned_Clusters <- function(som.model, clusters, phos_mat ){
  som.cluster.asignedclusters <- Asign_To_Clusters(som.model = som.model, 
                 clusters = clusters) 
  
  phos_mat_t <- as.data.frame( t(phos_mat) )
  phos_mat_t$cluster <-   som.cluster.asignedclusters[rownames(phos_mat_t)]
    
  phos_mat_t <- phos_mat_t %>%
      rownames_to_column( "peptide") %>%
      pivot_longer(-c(peptide, cluster), names_to = "sample", values_to = "log2FC")   %>%
      mutate(sample = gsub( "log2FC_", "", sample)) %>%
      separate(sample, into = c("type", "replicate"), sep = "-",remove = F) %>%
      separate(peptide, into = c("HGNC_Symbol", "Annotated_Sequence"), sep = "_",   remove = F ) %>%
      mutate(type = as.factor(type)) 
  return(phos_mat_t)
}

Plot_Profiles_SOM_clusters <- function(som.model, clusters, phos_mat, ncol_grid=4, specific_cluster = FALSE ){
    phos_mat_t <- Get_Mat_With_Assigned_Clusters(som.model, clusters, phos_mat)
    phos_mat_t <- phos_mat_t %>%
      mutate(type = factor(type, levels = c("WT", "G34R", "K27M"))) 
  
  mean_per_type <- 
    phos_mat_t %>%
    group_by(sample, type) %>%
    summarise(log2FC= median(log2FC)) %>%
    ungroup() %>%
    group_by(type) %>%
    summarise(mean_log2FC = mean(log2FC)) %>%
    ungroup() %>%
    column_to_rownames("type") %>% 
    t %>% as_tibble()
  
  if(specific_cluster){
    phos_mat_t <- phos_mat_t %>% 
      filter(cluster==specific_cluster)
  }
  
  phos_mat_t %>% 
    filter(!is.na(cluster)) %>%
      #filter(cluster==19) %>%
      ggplot(aes( sample, log2FC, fill = type, group = peptide )) +
      geom_line(alpha = 0.3) +
      theme_bw() +
      theme(axis.text.x = element_text(angle = 90),
            axis.title.x = element_blank()) +
      scale_color_manual(values = PGPalette[c(5,1,2)]) +
      facet_wrap(~cluster, ncol = ncol_grid) +
      geom_hline(col = PGPalette[5], yintercept = mean_per_type$WT) +
      geom_hline(col = PGPalette[1], yintercept = mean_per_type$G34R) +
      geom_hline(col = PGPalette[2], yintercept = mean_per_type$K27M) +
    geom_point(alpha = 0.3, aes(col = type), size = 0.4)
}

Confusion_Matrix <- function(cluster){
  as.data.frame(Asign_To_Clusters(som.model.pat, cluster) ) %>% 
  rownames_to_column("type") %>% 
  mutate(type = str_remove(str_split( type, "-", simplify = T )[,1], "log2FC_" ) ) %>% table
}
```

### StringDB
```{r, eval=TRUE}
Plot_StringDB <- function(hits){
  hits <- as.data.frame(hits)
  colnames(hits) <- "HGNC_Symbol"
  hits_mapped <- string_db$map( hits, "HGNC_Symbol", removeUnmappedRows = TRUE )
  string_db$plot_network( hits_mapped)
}
```

## Prepare data
```{r, fig.width=10, fig.height=10}
overlap_pat <- intersect(rownames(pST_mat_nonormal_normtomedian), rownames(pY_mat_nonormal_normtomedian))
stopifnot(rownames(pST_mat_nonormal_normtomedian[overlap_pat,]) == rownames(pY_mat_nonormal_normtomedian[overlap_pat,]) )

pYpST_mat_nonormal <- cbind(pY_mat_nonormal_normtomedian[overlap_pat,], pST_mat_nonormal_normtomedian[overlap_pat,])
```

# SOMs
## Peptide - pY (no normal)
### train the SOM
```{r train_the_som_peptides_pY , warning=FALSE}
som.pept.pY <- Train_SOM(phos_mat= t(pY_mat_nonormal), try.k = 2:50)
som.model.pept.pY <- som.pept.pY[[1]]
som.events.pept.pY <- som.pept.pY[[2]]
```

### evaluate clustering algorithms
```{r}
## Having selected a reasonable value for k, evaluate different clustering algorithms.

## Try several different clustering algorithms, and, if desired, different values for k
cluster.tries.pept.pY <- list()

for(k in c(10, 12, 15)){
  ## k-means clustering
  
  som.cluster.k <- kmeans(som.events.pept.pY, centers = k, iter.max = 100, nstart = 10)$cluster # k-means
  
  ## hierarchical clustering
  
  som.dist.pept <- dist(som.events.pept.pY) # hierarchical, step 1
  #som.cluster.h <- cutree(hclust(som.dist.pept), k = k) # hierarchical, step 2
  
  ## capture outputs
  cluster.tries.pept.pY[[paste0('som.cluster.k.', k)]] <- som.cluster.k
  #cluster.tries.pept.pY[[paste0('som.cluster.h.', k)]] <- som.cluster.h
}

## Take a look at the various clusters.  You're looking for the algorithm that produces the
## least fragmented clusters.

message("k10")
Plot_Colored_SOM(som.model.pept.pY, 
                 cluster.tries.pept.pY$som.cluster.k.10, cl = 10)
message("k12")
Plot_Colored_SOM(som.model.pept.pY, 
                 cluster.tries.pept.pY$som.cluster.k.12, cl = 12)
message("k15")
Plot_Colored_SOM(som.model.pept.pY, 
                 cluster.tries.pept.pY$som.cluster.k.15, cl = 15)

#cluster.tries.pept.pY$som.cluster.k.20

message("Members in each cluster (k12):")
sort(table(Asign_To_Clusters(som.model.pept.pY, cluster.tries.pept.pY$som.cluster.k.12))) 
```

### Abundance across all peptides
```{r}
t(pY_mat_nonormal) %>%
  as.data.frame(  ) %>%
  rownames_to_column( "peptide") %>%
  pivot_longer(-peptide, names_to = "sample", values_to = "log2FC") %>%
  mutate(sample = gsub( "log2FC_", "", sample)) %>%
  separate(sample, into = c("type", "replicate"), sep = "-",remove = F)   %>%
  separate(peptide, into = c("HGNC_Symbol", "Annotated_Sequence"), sep =   "_", remove = F ) %>%
  group_by(sample, type, replicate) %>%
  summarise("Mean of cluster" = mean(log2FC)) %>%
  ungroup() %>%
  mutate(type = as.factor(type)) %>%
  mutate(type = factor(type, levels = c("WT", "G34R", "K27M"))) %>%
  ggplot(aes( type, `Mean of cluster`, fill = type )) +
  geom_boxplot(outlier.size = 0) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90),
  axis.title.x = element_blank()) +
  scale_fill_manual(values = PGPalette[c(5,1,2)]) +
  ggbeeswarm::geom_beeswarm() +
  ggpubr::stat_compare_means(method = "t.test",
  comparisons = list(c("WT", "G34R"),
  c("WT", "K27M"),
  c("K27M", "G34R")) )

```

### Analysis clusters
#### k 10
##### Profiles for all clusters
```{r, fig.width=10, fig.height=10}
Plot_Profiles_SOM_clusters(som.model = som.model.pept.pY,
                           clusters = cluster.tries.pept.pY$som.cluster.k.10,
                           phos_mat = pY_mat_nonormal)
```

##### Abundance per group for each cluster
```{r}
Get_Mat_With_Assigned_Clusters(som.model = som.model.pept.pY,
                                clusters = cluster.tries.pept.pY$som.cluster.k.10,
                                phos_mat = pY_mat_nonormal) %>%
  group_by(sample, type, replicate, cluster) %>%
    summarise("Mean of cluster" = mean(log2FC)) %>%
    ungroup() %>%
    mutate(type = as.factor(type)) %>%
    mutate(type = factor(type, levels = c("WT", "G34R", "K27M"))) %>%
    ggplot(aes( type, `Mean of cluster`, fill = type )) +
    geom_boxplot(outlier.size = 0) +
    theme_bw() +
    theme(axis.text.x = element_text(angle = 90),
          axis.title.x = element_blank()) +
    scale_fill_manual(values = PGPalette[c(5,1,2)]) +
    ggbeeswarm::geom_beeswarm() +
    ggpubr::stat_compare_means(method = "t.test", 
                               comparisons = list(c("WT", "G34R"), 
                                                  c("WT", "K27M"),
                                                  c("K27M", "G34R")) ) +
  facet_wrap(~cluster, ncol = 5)
```

##### Per group across all clusters
```{r}
som.cluster.k.20.asignedclusters <- Asign_To_Clusters(som.model = som.model.pept.pY, 
               clusters = cluster.tries.pept.pY$som.cluster.k.10) 

pY_mat_nonormal_t <- as.data.frame( t(pY_mat_nonormal) )
pY_mat_nonormal_t$cluster <- som.cluster.k.20.asignedclusters[rownames(pY_mat_nonormal_t)]
  
pY_mat_nonormal_t <- pY_mat_nonormal_t %>%
    rownames_to_column( "peptide") %>%
    pivot_longer(-c(peptide, cluster), names_to = "sample", values_to = "log2FC") %>%
    mutate(sample = gsub( "log2FC_", "", sample)) %>%
    separate(sample, into = c("type", "replicate"), sep = "-",remove = F) %>%
    separate(peptide, into = c("HGNC_Symbol", "Annotated_Sequence"), sep = "_", remove = F ) %>%
    mutate(type = as.factor(type)) %>%
    mutate(type = factor(type, levels = c("WT", "G34R", "K27M"))) 
  
pY_mat_nonormal_t %>%
    group_by(sample, type, replicate, cluster) %>%
    summarise("Mean of cluster" = mean(log2FC)) %>%
    ungroup() %>%
    ggplot(aes( cluster, `Mean of cluster`, fill = type, group = cluster )) +
    geom_boxplot(outlier.size = 0) +
    theme_bw() +
    theme(axis.text.x = element_text(angle = 90),
          axis.title.x = element_blank()) +
    scale_fill_manual(values = PGPalette[c(5,1,2)]) +
    ggbeeswarm::geom_beeswarm() +
    geom_hline(yintercept = 0) +
    facet_grid(type~.)
```

```{r}
k10cl_pY <- Asign_To_Clusters(som.model.pept.pY, cluster.tries.pept.pY$som.cluster.k.10)
# PLSDA pY comp1
k10cl_pY[which(grepl("SIRPA", names(k10cl_pY) )) ]
k10cl_pY[which(grepl("NCK1", names(k10cl_pY) )) ]
k10cl_pY[which(grepl("CTTN", names(k10cl_pY) )) ]
k10cl_pY[which(grepl("MAPK12", names(k10cl_pY) )) ]
k10cl_pY[which(grepl("PTK2", names(k10cl_pY) )) ]
k10cl_pY[which(grepl("GAB2", names(k10cl_pY) )) ]
k10cl_pY[which(grepl("KIRREL1", names(k10cl_pY) )) ]
k10cl_pY[which(grepl("BCAR1", names(k10cl_pY) )) ]
# PLSDA pY comp2
k10cl_pY[which(grepl("CTNNA1", names(k10cl_pY) )) ]
k10cl_pY[which(grepl("VIM", names(k10cl_pY) )) ]
k10cl_pY[which(grepl("PSMA2", names(k10cl_pY) )) ]
k10cl_pY[which(grepl("SRSF9", names(k10cl_pY) )) ]
```



#### k 12
##### Profiles for all clusters
```{r, fig.width=10, fig.height=10}
Plot_Profiles_SOM_clusters(som.model = som.model.pept.pY,
                           clusters = cluster.tries.pept.pY$som.cluster.k.12,
                           phos_mat = pY_mat_nonormal)
```

##### String-db specific clusters
```{r Plot_StringDB_SOMs_pY, fig.width=8, fig.height=8, eval=FALSE}
for(i in c(1, 5, 6, 8, 9, 10, 13, 15, 18, 19 )){
Plot_StringDB(
  (Get_Members_Of_One_Cluster(som.model = som.model.pept.pY, 
                             clusters = cluster.tries.pept.pY$som.cluster.k.12,
                             n = i) %>%
    str_split("_", simplify = T) %>% .[,1] %>%
    unique ) )
}
```

##### Abundance per group for each cluster
```{r}
Get_Mat_With_Assigned_Clusters(som.model = som.model.pept.pY,
                                clusters = cluster.tries.pept.pY$som.cluster.k.12,
                                phos_mat = pY_mat_nonormal) %>%
  group_by(sample, type, replicate, cluster) %>%
    summarise("Mean of cluster" = mean(log2FC)) %>%
    ungroup() %>%
    mutate(type = as.factor(type)) %>%
    mutate(type = factor(type, levels = c("WT", "G34R", "K27M"))) %>%
    ggplot(aes( type, `Mean of cluster`, fill = type )) +
    geom_boxplot(outlier.size = 0) +
    theme_bw() +
    theme(axis.text.x = element_text(angle = 90),
          axis.title.x = element_blank()) +
    scale_fill_manual(values = PGPalette[c(5,1,2)]) +
    ggbeeswarm::geom_beeswarm() +
    ggpubr::stat_compare_means(method = "t.test", 
                               comparisons = list(c("WT", "G34R"), 
                                                  c("WT", "K27M"),
                                                  c("K27M", "G34R")) ) +
  facet_wrap(~cluster, ncol = 5)
```

##### Per group across all clusters
```{r}
som.cluster.k.20.asignedclusters <- Asign_To_Clusters(som.model = som.model.pept.pY, 
               clusters = cluster.tries.pept.pY$som.cluster.k.12) 

pY_mat_nonormal_t <- as.data.frame( t(pY_mat_nonormal) )
pY_mat_nonormal_t$cluster <- som.cluster.k.20.asignedclusters[rownames(pY_mat_nonormal_t)]
  
pY_mat_nonormal_t <- pY_mat_nonormal_t %>%
    rownames_to_column( "peptide") %>%
    pivot_longer(-c(peptide, cluster), names_to = "sample", values_to = "log2FC") %>%
    mutate(sample = gsub( "log2FC_", "", sample)) %>%
    separate(sample, into = c("type", "replicate"), sep = "-",remove = F) %>%
    separate(peptide, into = c("HGNC_Symbol", "Annotated_Sequence"), sep = "_", remove = F ) %>%
    mutate(type = as.factor(type)) %>%
    mutate(type = factor(type, levels = c("WT", "G34R", "K27M"))) 
  
pY_mat_nonormal_t %>%
    group_by(sample, type, replicate, cluster) %>%
    summarise("Mean of cluster" = mean(log2FC)) %>%
    ungroup() %>%
    ggplot(aes( cluster, `Mean of cluster`, fill = type, group = cluster )) +
    geom_boxplot(outlier.size = 0) +
    theme_bw() +
    theme(axis.text.x = element_text(angle = 90),
          axis.title.x = element_blank()) +
    scale_fill_manual(values = PGPalette[c(5,1,2)]) +
    ggbeeswarm::geom_beeswarm() +
    geom_hline(yintercept = 0) +
    facet_grid(type~.)
```

```{r}
k12cl_pY <- Asign_To_Clusters(som.model.pept.pY, cluster.tries.pept.pY$som.cluster.k.12)
# PLSDA pY comp1
k12cl_pY[which(grepl("SIRPA", names(k12cl_pY) )) ]
k12cl_pY[which(grepl("NCK1", names(k12cl_pY) )) ]
k12cl_pY[which(grepl("CTTN", names(k12cl_pY) )) ]
k12cl_pY[which(grepl("MAPK12", names(k12cl_pY) )) ]
k12cl_pY[which(grepl("PTK2", names(k12cl_pY) )) ]
k12cl_pY[which(grepl("GAB2", names(k12cl_pY) )) ]
k12cl_pY[which(grepl("KIRREL1", names(k12cl_pY) )) ]
k12cl_pY[which(grepl("BCAR1", names(k12cl_pY) )) ]
# PLSDA pY comp2
k12cl_pY[which(grepl("CTNNA1", names(k12cl_pY) )) ]
k12cl_pY[which(grepl("VIM", names(k12cl_pY) )) ]
k12cl_pY[which(grepl("PSMA2", names(k12cl_pY) )) ]
k12cl_pY[which(grepl("SRSF9", names(k12cl_pY) )) ]
```



## Peptide - pST (no normal)
### train the SOM
```{r train_the_som_peptides_pST , warning=FALSE}
som.pept.pST <- Train_SOM(phos_mat= t(pST_mat_nonormal), try.k = 2:100)
som.model.pept.pST <- som.pept.pST[[1]]
som.events.pept.pST <- som.pept.pST[[2]]
```

### evaluate clustering algorithms
```{r}
## Having selected a reasonable value for k, evaluate different clustering algorithms.

## Try several different clustering algorithms, and, if desired, different values for k
cluster.tries.pept.pST <- list()

for(k in c(10, 20, 30, 40)){
  ## k-means clustering
  
  som.cluster.k <- kmeans(som.events.pept.pST, centers = k, iter.max = 100, nstart = 10)$cluster # k-means
  
  ## hierarchical clustering
  
  som.dist.pept <- dist(som.events.pept.pST) # hierarchical, step 1
  #som.cluster.h <- cutree(hclust(som.dist.pept), k = k) # hierarchical, step 2
  
  ## capture outputs
  cluster.tries.pept.pST[[paste0('som.cluster.k.', k)]] <- som.cluster.k
  #cluster.tries.pept.pST[[paste0('som.cluster.h.', k)]] <- som.cluster.h
}

## Take a look at the various clusters.  You're looking for the algorithm that produces the
## least fragmented clusters.

#Plot_Colored_SOM(som.model.pept.pST, cluster.tries.pept.pST$som.cluster.h.10)
#Plot_Colored_SOM(som.model.pept.pST, cluster.tries.pept.pST$som.cluster.h.20)
#Plot_Colored_SOM(som.model.pept.pST, cluster.tries.pept.pST$som.cluster.h.30)
#Plot_Colored_SOM(som.model.pept.pST, cluster.tries.pept.pST$som.cluster.h.40)

message("k10")
Plot_Colored_SOM(som.model.pept.pST, 
                 cluster.tries.pept.pST$som.cluster.k.10, cl = 10)
message("k20")
Plot_Colored_SOM(som.model.pept.pST, 
                 cluster.tries.pept.pST$som.cluster.k.20, cl = 20)
message("k30")
Plot_Colored_SOM(som.model.pept.pST, 
                 cluster.tries.pept.pST$som.cluster.k.30, cl = 30)
message("k40")
Plot_Colored_SOM(som.model.pept.pST, 
                 cluster.tries.pept.pST$som.cluster.k.40, cl = 40)

#cluster.tries.pept.pST$som.cluster.k.20

#Asign_To_Clusters(som.model.pept.pST, cluster.tries.pept.pST$som.cluster.k.10)
#Asign_To_Clusters(som.model.pept.pST, cluster.tries.pept.pST$som.cluster.k.30)
#Asign_To_Clusters(som.model.pept.pST, cluster.tries.pept.pST$som.cluster.k.40)
message("Members in each cluster (k20):")
sort(table(Asign_To_Clusters(som.model.pept.pST, cluster.tries.pept.pST$som.cluster.k.20))) 
message("Members in each cluster (k30):")
sort(table(Asign_To_Clusters(som.model.pept.pST, cluster.tries.pept.pST$som.cluster.k.30))) 

#Get_Members_Of_One_Cluster(som.model = som.model.pept.pST, 
#                             clusters = cluster.tries.pept.pST$som.cluster.k.40,
#                             n = 25)
```

### Abundance across all peptides
```{r}
t(pST_mat_nonormal) %>%
  as.data.frame(  ) %>%
  rownames_to_column( "peptide") %>%
  pivot_longer(-peptide, names_to = "sample", values_to = "log2FC") %>%
  mutate(sample = gsub( "log2FC_", "", sample)) %>%
  separate(sample, into = c("type", "replicate"), sep = "-",remove = F)   %>%
  separate(peptide, into = c("HGNC_Symbol", "Annotated_Sequence"), sep =   "_", remove = F ) %>%
  group_by(sample, type, replicate) %>%
  summarise("Mean of cluster" = mean(log2FC)) %>%
  ungroup() %>%
  mutate(type = as.factor(type)) %>%
  mutate(type = factor(type, levels = c("WT", "G34R", "K27M"))) %>%
  ggplot(aes( type, `Mean of cluster`, fill = type )) +
  geom_boxplot(outlier.size = 0) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90),
  axis.title.x = element_blank()) +
  scale_fill_manual(values = PGPalette[c(5,1,2)]) +
  ggbeeswarm::geom_beeswarm() +
  ggpubr::stat_compare_means(method = "t.test",
  comparisons = list(c("WT", "G34R"),
  c("WT", "K27M"),
  c("K27M", "G34R")) )

```

### Analysis clusters
#### k 20
##### Profiles for all clusters
```{r, fig.width=10, fig.height=10}
Plot_Profiles_SOM_clusters(som.model = som.model.pept.pST,
                           clusters = cluster.tries.pept.pST$som.cluster.k.20,
                           phos_mat = pST_mat_nonormal)
```

##### String-db specific clusters
```{r Plot_StringDB_SOMs_pST, fig.width=8, fig.height=8, eval=FALSE}
for(i in c(1, 5, 6, 8, 9, 10, 13, 15, 18, 19 )){
Plot_StringDB(
  (Get_Members_Of_One_Cluster(som.model = som.model.pept.pST, 
                             clusters = cluster.tries.pept.pST$som.cluster.k.20,
                             n = i) %>%
    str_split("_", simplify = T) %>% .[,1] %>%
    unique ) )
}
```

##### Abundance per group for each cluster
```{r}
Get_Mat_With_Assigned_Clusters(som.model = som.model.pept.pST,
                                clusters = cluster.tries.pept.pST$som.cluster.k.20,
                                phos_mat = pST_mat_nonormal) %>%
  group_by(sample, type, replicate, cluster) %>%
    summarise("Mean of cluster" = mean(log2FC)) %>%
    ungroup() %>%
    mutate(type = as.factor(type)) %>%
    mutate(type = factor(type, levels = c("WT", "G34R", "K27M"))) %>%
    ggplot(aes( type, `Mean of cluster`, fill = type )) +
    geom_boxplot(outlier.size = 0) +
    theme_bw() +
    theme(axis.text.x = element_text(angle = 90),
          axis.title.x = element_blank()) +
    scale_fill_manual(values = PGPalette[c(5,1,2)]) +
    ggbeeswarm::geom_beeswarm() +
    ggpubr::stat_compare_means(method = "t.test", 
                               comparisons = list(c("WT", "G34R"), 
                                                  c("WT", "K27M"),
                                                  c("K27M", "G34R")) ) +
  facet_wrap(~cluster, ncol = 5)
```

##### Per group across all clusters
```{r}
som.cluster.k.20.asignedclusters <- Asign_To_Clusters(som.model = som.model.pept.pST, 
               clusters = cluster.tries.pept.pST$som.cluster.k.20) 

pST_mat_nonormal_t <- as.data.frame( t(pST_mat_nonormal) )
pST_mat_nonormal_t$cluster <- som.cluster.k.20.asignedclusters[rownames(pST_mat_nonormal_t)]
  
pST_mat_nonormal_t <- pST_mat_nonormal_t %>%
    rownames_to_column( "peptide") %>%
    pivot_longer(-c(peptide, cluster), names_to = "sample", values_to = "log2FC") %>%
    mutate(sample = gsub( "log2FC_", "", sample)) %>%
    separate(sample, into = c("type", "replicate"), sep = "-",remove = F) %>%
    separate(peptide, into = c("HGNC_Symbol", "Annotated_Sequence"), sep = "_", remove = F ) %>%
    mutate(type = as.factor(type)) %>%
    mutate(type = factor(type, levels = c("WT", "G34R", "K27M"))) 
  
pST_mat_nonormal_t %>%
    group_by(sample, type, replicate, cluster) %>%
    summarise("Mean of cluster" = mean(log2FC)) %>%
    ungroup() %>%
    ggplot(aes( cluster, `Mean of cluster`, fill = type, group = cluster )) +
    geom_boxplot(outlier.size = 0) +
    theme_bw() +
    theme(axis.text.x = element_text(angle = 90),
          axis.title.x = element_blank()) +
    scale_fill_manual(values = PGPalette[c(5,1,2)]) +
    ggbeeswarm::geom_beeswarm() +
    geom_hline(yintercept = 0) +
    facet_grid(type~.)
```


#### k 30
##### Profiles for all clusters
```{r, fig.width=10, fig.height=16}
Plot_Profiles_SOM_clusters(som.model = som.model.pept.pST,
                           clusters = cluster.tries.pept.pST$som.cluster.k.30,
                           phos_mat = pST_mat_nonormal)
```

##### String-db specific clusters
```{r, fig.width=8, fig.height=8, eval=FALSE}
for(i in c(1, 5, 6, 18, 19, 23, 25, 26 )){
Plot_StringDB(
  (Get_Members_Of_One_Cluster(som.model = som.model.pept.pST, 
                             clusters = cluster.tries.pept.pST$som.cluster.k.30,
                             n = i) %>%
    str_split("_", simplify = T) %>% .[,1] %>%
    unique ) )
}
```

##### Abundance per group for each cluster
```{r}
Get_Mat_With_Assigned_Clusters(som.model = som.model.pept.pST,
                                clusters = cluster.tries.pept.pST$som.cluster.k.30,
                                phos_mat = pST_mat_nonormal) %>%
  group_by(sample, type, replicate, cluster) %>%
    summarise("Mean of cluster" = mean(log2FC)) %>%
    ungroup() %>%
    mutate(type = as.factor(type)) %>%
    mutate(type = factor(type, levels = c("WT", "G34R", "K27M"))) %>%
    ggplot(aes( type, `Mean of cluster`, fill = type )) +
    geom_boxplot(outlier.size = 0) +
    theme_bw() +
    theme(axis.text.x = element_text(angle = 90),
          axis.title.x = element_blank()) +
    scale_fill_manual(values = PGPalette[c(5,1,2)]) +
    ggbeeswarm::geom_beeswarm() +
    ggpubr::stat_compare_means(method = "t.test", 
                               comparisons = list(c("WT", "G34R"), 
                                                  c("WT", "K27M"),
                                                  c("K27M", "G34R")) ) +
  facet_wrap(~cluster, ncol = 5)
```


## Peptide - pY + pST (no normal)
### train the SOM
```{r train_the_som_peptides_pYpST , warning=FALSE}
som.pept.pYpST <- Train_SOM(phos_mat= t(pYpST_mat_nonormal), try.k = 2:100)
som.model.pept.pYpST <- som.pept.pYpST[[1]]
som.events.pept.pYpST <- som.pept.pYpST[[2]]
```

### evaluate clustering algorithms
```{r}
## Having selected a reasonable value for k, evaluate different clustering algorithms.

## Try several different clustering algorithms, and, if desired, different values for k
cluster.tries.pept.pYpST <- list()

for(k in c(10, 20, 30, 40)){
  ## k-means clustering
  
  som.cluster.k <- kmeans(som.events.pept.pYpST, centers = k, iter.max = 100, nstart = 10)$cluster # k-means
  
  ## hierarchical clustering
  
  som.dist.pept <- dist(som.events.pept.pYpST) # hierarchical, step 1
  #som.cluster.h <- cutree(hclust(som.dist.pept), k = k) # hierarchical, step 2
  
  ## capture outputs
  cluster.tries.pept.pYpST[[paste0('som.cluster.k.', k)]] <- som.cluster.k
  #cluster.tries.pept.pYpST[[paste0('som.cluster.h.', k)]] <- som.cluster.h
}

## Take a look at the various clusters.  You're looking for the algorithm that produces the
## least fragmented clusters.

#Plot_Colored_SOM(som.model.pept.pYpST, cluster.tries.pept.pYpST$som.cluster.h.10)
#Plot_Colored_SOM(som.model.pept.pYpST, cluster.tries.pept.pYpST$som.cluster.h.20)
#Plot_Colored_SOM(som.model.pept.pYpST, cluster.tries.pept.pYpST$som.cluster.h.30)
#Plot_Colored_SOM(som.model.pept.pYpST, cluster.tries.pept.pYpST$som.cluster.h.40)

message("k10")
Plot_Colored_SOM(som.model.pept.pYpST, 
                 cluster.tries.pept.pYpST$som.cluster.k.10, cl = 10)
message("k20")
Plot_Colored_SOM(som.model.pept.pYpST, 
                 cluster.tries.pept.pYpST$som.cluster.k.20, cl = 20)
message("k30")
Plot_Colored_SOM(som.model.pept.pYpST, 
                 cluster.tries.pept.pYpST$som.cluster.k.30, cl = 30)
message("k40")
Plot_Colored_SOM(som.model.pept.pYpST, 
                 cluster.tries.pept.pYpST$som.cluster.k.40, cl = 40)

#cluster.tries.pept.pYpST$som.cluster.k.20

#Asign_To_Clusters(som.model.pept.pYpST, cluster.tries.pept.pYpST$som.cluster.k.10)
#Asign_To_Clusters(som.model.pept.pYpST, cluster.tries.pept.pYpST$som.cluster.k.30)
#Asign_To_Clusters(som.model.pept.pYpST, cluster.tries.pept.pYpST$som.cluster.k.40)
message("Members in each cluster (k20):")
sort(table(Asign_To_Clusters(som.model.pept.pYpST, cluster.tries.pept.pYpST$som.cluster.k.20))) 
message("Members in each cluster (k30):")
sort(table(Asign_To_Clusters(som.model.pept.pYpST, cluster.tries.pept.pYpST$som.cluster.k.30))) 
message("Members in each cluster (k40):")
sort(table(Asign_To_Clusters(som.model.pept.pYpST, cluster.tries.pept.pYpST$som.cluster.k.40))) 

#Get_Members_Of_One_Cluster(som.model = som.model.pept.pYpST, 
#                             clusters = cluster.tries.pept.pYpST$som.cluster.k.40,
#                             n = 25)
```

```{r}
k40cl <- Asign_To_Clusters(som.model.pept.pYpST, cluster.tries.pept.pYpST$som.cluster.k.40)

xl_l40cl <- str_split( names(k40cl), "_", simplify = T ) %>% as.data.frame()
colnames(xl_l40cl) <- c("HGNC_Symbol", "Sequence")
xl_l40cl$SOMs_cluster <- k40cl
xl_l40cl %>% write.table(quote = FALSE, col.names = T, file = "../Data/For_collaborators/Batch1_SOMs_cluster_k40.txt", row.names = F)

# PLSDA pYpST comp1
k40cl[which(grepl("RNF31", names(k40cl) )) ]
k40cl[which(grepl("SIPA1L1", names(k40cl) )) ]
# PLSDA pYpST comp2
k40cl[which(grepl("DAB2IP", names(k40cl) )) ]
k40cl[which(grepl("SIRPA", names(k40cl) )) ]
k40cl[which(grepl("EPB41L1", names(k40cl) )) ]
k40cl[which(grepl("WASL", names(k40cl) )) ]
k40cl[which(grepl("CADPS", names(k40cl) )) ]
k40cl[which(grepl("EPB41L3", names(k40cl) )) ]
```

### Abundance across all peptides
```{r}
t(pYpST_mat_nonormal) %>%
  as.data.frame(  ) %>%
  rownames_to_column( "peptide") %>%
  pivot_longer(-peptide, names_to = "sample", values_to = "log2FC") %>%
  mutate(sample = gsub( "log2FC_", "", sample)) %>%
  separate(sample, into = c("type", "replicate"), sep = "-",remove = F)   %>%
  separate(peptide, into = c("HGNC_Symbol", "Annotated_Sequence"), sep =   "_", remove = F ) %>%
  group_by(sample, type, replicate) %>%
  summarise("Mean of cluster" = mean(log2FC)) %>%
  ungroup() %>%
  mutate(type = as.factor(type)) %>%
  mutate(type = factor(type, levels = c("WT", "G34R", "K27M"))) %>%
  ggplot(aes( type, `Mean of cluster`, fill = type )) +
  geom_boxplot(outlier.size = 0) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90),
  axis.title.x = element_blank()) +
  scale_fill_manual(values = PGPalette[c(5,1,2)]) +
  ggbeeswarm::geom_beeswarm() +
  ggpubr::stat_compare_means(method = "t.test",
  comparisons = list(c("WT", "G34R"),
  c("WT", "K27M"),
  c("K27M", "G34R")) )

```

### Analysis clusters
#### k 20
##### Profiles for all clusters
```{r, fig.width=10, fig.height=10}
Plot_Profiles_SOM_clusters(som.model = som.model.pept.pYpST,
                           clusters = cluster.tries.pept.pYpST$som.cluster.k.20,
                           phos_mat = pYpST_mat_nonormal)
```

##### String-db specific clusters
```{r Plot_StringDB_SOMs_pYpST, fig.width=8, fig.height=8, eval=FALSE}
for(i in c(1, 5, 6, 8, 9, 10, 13, 15, 18, 19 )){
Plot_StringDB(
  (Get_Members_Of_One_Cluster(som.model = som.model.pept.pYpST, 
                             clusters = cluster.tries.pept.pYpST$som.cluster.k.20,
                             n = i) %>%
    str_split("_", simplify = T) %>% .[,1] %>%
    unique ) )
}
```

##### Abundance per group for each cluster
```{r, fig.height=8}
Get_Mat_With_Assigned_Clusters(som.model = som.model.pept.pYpST,
                                clusters = cluster.tries.pept.pYpST$som.cluster.k.20,
                                phos_mat = pYpST_mat_nonormal) %>%
  group_by(sample, type, replicate, cluster) %>%
    summarise("Mean of cluster" = mean(log2FC)) %>%
    ungroup() %>%
    mutate(type = as.factor(type)) %>%
    mutate(type = factor(type, levels = c("WT", "G34R", "K27M"))) %>%
    ggplot(aes( type, `Mean of cluster`, fill = type )) +
    geom_boxplot(outlier.size = 0) +
    theme_bw() +
    theme(axis.text.x = element_text(angle = 90),
          axis.title.x = element_blank()) +
    scale_fill_manual(values = PGPalette[c(5,1,2)]) +
    ggbeeswarm::geom_beeswarm() +
    ggpubr::stat_compare_means(method = "t.test", 
                               comparisons = list(c("WT", "G34R"), 
                                                  c("WT", "K27M"),
                                                  c("K27M", "G34R")) ) +
  facet_wrap(~cluster, ncol = 5)
```

##### Per group across all clusters
```{r}
som.cluster.k.20.asignedclusters <- Asign_To_Clusters(som.model = som.model.pept.pYpST, 
               clusters = cluster.tries.pept.pYpST$som.cluster.k.20) 

pYpST_mat_nonormal_t <- as.data.frame( t(pYpST_mat_nonormal) )
pYpST_mat_nonormal_t$cluster <- som.cluster.k.20.asignedclusters[rownames(pYpST_mat_nonormal_t)]
  
pYpST_mat_nonormal_t <- pYpST_mat_nonormal_t %>%
    rownames_to_column( "peptide") %>%
    pivot_longer(-c(peptide, cluster), names_to = "sample", values_to = "log2FC") %>%
    mutate(sample = gsub( "log2FC_", "", sample)) %>%
    separate(sample, into = c("type", "replicate"), sep = "-",remove = F) %>%
    separate(peptide, into = c("HGNC_Symbol", "Annotated_Sequence"), sep = "_", remove = F ) %>%
    mutate(type = as.factor(type)) %>%
    mutate(type = factor(type, levels = c("WT", "G34R", "K27M"))) 
  
pYpST_mat_nonormal_t %>%
    group_by(sample, type, replicate, cluster) %>%
    summarise("Mean of cluster" = mean(log2FC)) %>%
    ungroup() %>%
    ggplot(aes( cluster, `Mean of cluster`, fill = type, group = cluster )) +
    geom_boxplot(outlier.size = 0) +
    theme_bw() +
    theme(axis.text.x = element_text(angle = 90),
          axis.title.x = element_blank()) +
    scale_fill_manual(values = PGPalette[c(5,1,2)]) +
    ggbeeswarm::geom_beeswarm() +
    geom_hline(yintercept = 0) +
    facet_grid(type~.)
```



#### k 30
##### Profiles for all clusters
```{r, fig.width=10, fig.height=16}
Plot_Profiles_SOM_clusters(som.model = som.model.pept.pYpST,
                           clusters = cluster.tries.pept.pYpST$som.cluster.k.30,
                           phos_mat = pYpST_mat_nonormal)
```

##### String-db specific clusters
```{r, fig.width=8, fig.height=8, eval=FALSE}
for(i in c(1, 5, 6, 18, 19, 23, 25, 26 )){
Plot_StringDB(
  (Get_Members_Of_One_Cluster(som.model = som.model.pept.pYpST, 
                             clusters = cluster.tries.pept.pYpST$som.cluster.k.30,
                             n = i) %>%
    str_split("_", simplify = T) %>% .[,1] %>%
    unique ) )
}
```

##### Abundance per group for each cluster
```{r, fig.height=10}
Get_Mat_With_Assigned_Clusters(som.model = som.model.pept.pYpST,
                                clusters = cluster.tries.pept.pYpST$som.cluster.k.30,
                                phos_mat = pYpST_mat_nonormal) %>%
  group_by(sample, type, replicate, cluster) %>%
    summarise("Mean of cluster" = mean(log2FC)) %>%
    ungroup() %>%
    mutate(type = as.factor(type)) %>%
    mutate(type = factor(type, levels = c("WT", "G34R", "K27M"))) %>%
    ggplot(aes( type, `Mean of cluster`, fill = type )) +
    geom_boxplot(outlier.size = 0) +
    theme_bw() +
    theme(axis.text.x = element_text(angle = 90),
          axis.title.x = element_blank()) +
    scale_fill_manual(values = PGPalette[c(5,1,2)]) +
    ggbeeswarm::geom_beeswarm() +
    ggpubr::stat_compare_means(method = "t.test", 
                               comparisons = list(c("WT", "G34R"), 
                                                  c("WT", "K27M"),
                                                  c("K27M", "G34R")) ) +
  facet_wrap(~cluster, ncol = 5)
```


#### k 40
##### Profiles for all clusters
```{r, fig.width=10, fig.height=20}
Plot_Profiles_SOM_clusters(som.model = som.model.pept.pYpST,
                           clusters = cluster.tries.pept.pYpST$som.cluster.k.40,
                           phos_mat = pYpST_mat_nonormal)
```

##### String-db specific clusters
```{r Plot_StringDB_SOMs_pYpST40, fig.width=8, fig.height=8, eval=TRUE}
for(i in c( 9, 10, 15, 16, 17, 21, 22, 23, 25, 26, 30, 33, 35, 36 )){
  message(paste("Cluster", i))
Plot_StringDB(
  (Get_Members_Of_One_Cluster(som.model = som.model.pept.pYpST, 
                             clusters = cluster.tries.pept.pYpST$som.cluster.k.40,
                             n = i) %>%
    str_split("_", simplify = T) %>% .[,1] %>%
    unique ) )
}
```

```{r, fig.width=8, fig.height=8, eval=TRUE}
for(i in c( 2, 3, 4, 19, 37, 38, 40 )){
  message(paste("Cluster", i))
Plot_StringDB(
  (Get_Members_Of_One_Cluster(som.model = som.model.pept.pYpST, 
                             clusters = cluster.tries.pept.pYpST$som.cluster.k.40,
                             n = i) %>%
    str_split("_", simplify = T) %>% .[,1] %>%
    unique ) )
}
```

##### Abundance per group for each cluster
```{r, fig.height=12, fig.width=10}
Get_Mat_With_Assigned_Clusters(som.model = som.model.pept.pYpST,
                                clusters = cluster.tries.pept.pYpST$som.cluster.k.40,
                                phos_mat = pYpST_mat_nonormal) %>%
  group_by(sample, type, replicate, cluster) %>%
    summarise("Mean of cluster" = mean(log2FC)) %>%
    ungroup() %>%
    mutate(type = as.factor(type)) %>%
    mutate(type = factor(type, levels = c("WT", "G34R", "K27M"))) %>%
    ggplot(aes( type, `Mean of cluster`, fill = type )) +
    geom_boxplot(outlier.size = 0) +
    theme_bw() +
    theme(axis.text.x = element_text(angle = 90),
          axis.title.x = element_blank()) +
    scale_fill_manual(values = PGPalette[c(5,1,2)]) +
    ggbeeswarm::geom_beeswarm() +
    ggpubr::stat_compare_means(method = "t.test", 
                               comparisons = list(c("WT", "G34R"), 
                                                  c("WT", "K27M"),
                                                  c("K27M", "G34R")) ) +
  facet_wrap(~cluster, ncol = 7)
```


##### Per group across all clusters
```{r}
som.cluster.k.40.asignedclusters <- Asign_To_Clusters(som.model = som.model.pept.pYpST, 
               clusters = cluster.tries.pept.pYpST$som.cluster.k.40) 

pYpST_mat_nonormal_t <- as.data.frame( t(pYpST_mat_nonormal) )
pYpST_mat_nonormal_t$cluster <- som.cluster.k.40.asignedclusters[rownames(pYpST_mat_nonormal_t)]
  
pYpST_mat_nonormal_t <- pYpST_mat_nonormal_t %>%
    rownames_to_column( "peptide") %>%
    pivot_longer(-c(peptide, cluster), names_to = "sample", values_to = "log2FC") %>%
    mutate(sample = gsub( "log2FC_", "", sample)) %>%
    separate(sample, into = c("type", "replicate"), sep = "-",remove = F) %>%
    separate(peptide, into = c("HGNC_Symbol", "Annotated_Sequence"), sep = "_", remove = F ) %>%
    mutate(type = as.factor(type)) %>%
    mutate(type = factor(type, levels = c("WT", "G34R", "K27M"))) 
  
pYpST_mat_nonormal_t %>%
    group_by(sample, type, replicate, cluster) %>%
    summarise("Mean of cluster" = mean(log2FC)) %>%
    ungroup() %>%
    ggplot(aes( cluster, `Mean of cluster`, fill = type, group = cluster )) +
    geom_boxplot(outlier.size = 0) +
    theme_bw() +
    theme(axis.text.x = element_text(angle = 90),
          axis.title.x = element_blank()) +
    scale_fill_manual(values = PGPalette[c(5,1,2)]) +
    ggbeeswarm::geom_beeswarm() +
    geom_hline(yintercept = 0) +
    facet_grid(type~.)
```


##### Some selected clusters
```{r}
for(i in c( 9, 10, 15, 16, 17, 21, 22, 23, 25, 26,30, 33, 35, 36 )){
 p <- Plot_Profiles_SOM_clusters(som.model = som.model.pept.pYpST,
                            clusters = cluster.tries.pept.pYpST$som.cluster.k.40,
                            phos_mat = pYpST_mat_nonormal, specific_cluster = i)
 print(p)
}
```

```{r}
for(i in c( 2, 3, 4, 19, 37, 38, 40 )){
 p <- Plot_Profiles_SOM_clusters(som.model = som.model.pept.pYpST,
                            clusters = cluster.tries.pept.pYpST$som.cluster.k.40,
                            phos_mat = pYpST_mat_nonormal, specific_cluster = i)
  print(p)
}
```

##### Get pYs for each cluster
```{r}
DT::datatable(Get_Mat_With_Assigned_Clusters(som.model = som.model.pept.pYpST,
                                clusters = cluster.tries.pept.pYpST$som.cluster.k.40,
                                phos_mat = pYpST_mat_nonormal) %>%
  select(HGNC_Symbol, Annotated_Sequence, cluster) %>%
  unique() %>%
  filter(grepl( "y", Annotated_Sequence )) %>%
  arrange(cluster) , rownames = FALSE)
```

##### For motif analysis 
```{r, eval=FALSE}
Get_Mat_With_Assigned_Clusters(som.model = som.model.pept.pYpST,
                                clusters = cluster.tries.pept.pYpST$som.cluster.k.40,
                                phos_mat = pYpST_mat_nonormal)
```

## Patients - No normal pY + pST

### train the SOM
```{r train_the_som_peptides_patpYpST, warning=FALSE}
som.pat <- Train_SOM(phos_mat= pYpST_mat_nonormal, try.k = 2:8)
som.model.pat <- som.pat[[1]]
som.events.pat <- som.pat[[2]]
```

### evaluate clustering algorithms
```{r}
## Having selected a reasonable value for k, evaluate different clustering algorithms.

## Define a function for make a simple plot of clustering output.
## This is the same as previousl plotting, but we define the function
## here as we wanted to play with the color earlier.

## Try several different clustering algorithms, and, if desired, different values for k

cluster.tries.pat.pYpST <- list()
for(k in c(3,4,5)){
  message(paste(k, "clusters"))
  ## k-means clustering
  som.cluster.k <- kmeans(som.events.pat, centers = k, iter.max = 100, nstart = 10)$cluster # k-means
  
  ## hierarchical clustering
  som.dist.pat <- dist(som.events.pat) # hierarchical, step 1
  som.cluster.h <- cutree(hclust(som.dist.pat), k = k) # hierarchical, step 2
  
  ## capture outputs
  cluster.tries.pat.pYpST[[paste0('som.cluster.k.', k)]] <- som.cluster.k
  cluster.tries.pat.pYpST[[paste0('som.cluster.h.', k)]] <- som.cluster.h
}
```

#### Hierarchical
```{r}
## Take a look at the various clusters.  You're looking for the algorithm that produces the
## least fragmented clusters.
Plot_Colored_SOM(som.model.pat, cluster.tries.pat.pYpST$som.cluster.h.3)
Plot_Colored_SOM(som.model.pat, cluster.tries.pat.pYpST$som.cluster.h.4)
Plot_Colored_SOM(som.model.pat, cluster.tries.pat.pYpST$som.cluster.h.5)

Asign_To_Clusters(som.model.pat, cluster.tries.pat.pYpST$som.cluster.h.3)
Asign_To_Clusters(som.model.pat, cluster.tries.pat.pYpST$som.cluster.h.4)
Asign_To_Clusters(som.model.pat, cluster.tries.pat.pYpST$som.cluster.h.5)

Confusion_Matrix(cluster.tries.pat.pYpST$som.cluster.h.3)
Confusion_Matrix(cluster.tries.pat.pYpST$som.cluster.h.4)
Confusion_Matrix(cluster.tries.pat.pYpST$som.cluster.h.5)
```

#### k-means
```{r}
Plot_Colored_SOM(som.model.pat, cluster.tries.pat.pYpST$som.cluster.k.3, cl=5)
Plot_Colored_SOM(som.model.pat, cluster.tries.pat.pYpST$som.cluster.k.4, cl=5)
Plot_Colored_SOM(som.model.pat, cluster.tries.pat.pYpST$som.cluster.k.5, cl=5)

Asign_To_Clusters(som.model.pat, cluster.tries.pat.pYpST$som.cluster.k.3)
Asign_To_Clusters(som.model.pat, cluster.tries.pat.pYpST$som.cluster.k.4)
Asign_To_Clusters(som.model.pat, cluster.tries.pat.pYpST$som.cluster.k.5)

Confusion_Matrix(cluster.tries.pat.pYpST$som.cluster.k.3)
Confusion_Matrix(cluster.tries.pat.pYpST$som.cluster.k.4)
Confusion_Matrix(cluster.tries.pat.pYpST$som.cluster.k.5)
```

# Session Info
```{r}
sessionInfo()
knitr::knit_exit()
```
