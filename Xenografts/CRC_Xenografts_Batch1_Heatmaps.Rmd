---
title: "Heatmaps - DIPG Batch 1"
author: Sophie Herbst
output:
  html_document:
    code_folding: hide
    toc: yes
    toc_depth: 4
    toc_float: yes
editor_options: 
  chunk_output_type: console
---
Analysis date: `r Sys.Date()`

# Depends on
DIPG_FirstBatch_DataProcessing Script

```{r}
load("../Data/Cache/DIPG_FirstBatch_DataProcessingMissingValues40.RData")
```

# TODO

* Find out whether I need to vsn
* Look at raw data from bridge channel
* Where do the missing values in whole proteome data come from?
* Whole proteome: Normalise abundances by total proteome abundance mean: did I do it correctly or do I have to mean center first?
* Match BBB and PKIDB properly
* Understand PLSDA results

# Setup
## Load libraries and functions
```{r, echo=FALSE, warning=FALSE, message=FALSE}
set.seed(2022)
library(fgsea)
library(AnnotationDbi)
library(org.Hs.eg.db)
library(DEP)
library(SummarizedExperiment)
# library(pls)
library(mdatools)
source("../../../General/Code/Analysis_Functions.R")
source("DIPG_FirstBatch_Functions.R")
```

## Median center correct extreme values
```{r}
#pY_mat_normtomedian <- t(log2(t(2^pY_mat)/colMedians(2^pY_mat) ))
pY_mat_normtomedian[pY_mat_normtomedian >4] <- 4
pY_mat_normtomedian[pY_mat_normtomedian < (-4)] <- (-4)

#pST_mat_normtomedian <- t(log2(t(2^pST_mat)/colMedians(2^pST_mat) ))
pST_mat_normtomedian[pST_mat_normtomedian >4] <- 4
pST_mat_normtomedian[pST_mat_normtomedian < (-4)] <- (-4)

#prot_mat_normtomedian <- t(log2(t(2^prot_mat)/colMedians(2^prot_mat) ))
prot_mat_normtomedian[prot_mat_normtomedian >5.6] <- 5.6
prot_mat_normtomedian[prot_mat_normtomedian < (-5.6)] <- (-5.6)
```

# Analysis
## Heatmaps log2 fold change normalised to ctrl
### Phospho-Tyrosines 
#### Clustered
```{r, fig.height=8, fig.width=10}
pY_mat_normtomedian %>% 
  pheatmap::pheatmap(col = colorRampPalette(c("navy", "white", "firebrick3"))(50), 
                     #labels_col = sub("_.*", "", colnames( pY_mat_normtomedian )), 
                     show_colnames = FALSE,
                     #scale = "column"  
                     )
```

#### No normal
```{r, fig.height=8, fig.width=10}
pY_mat_normtomedian[!grepl("normal", rownames(pY_mat_normtomedian) ),] %>% 
  pheatmap::pheatmap(col = colorRampPalette(c("navy", "white", "firebrick3"))(50), 
                     #labels_col = sub("_.*", "", colnames( pY_mat_normtomedian[!grepl("normal", rownames(pY_mat_normtomedian) ),] )), 
                     show_colnames = FALSE,
                     #scale = "column"   
                     )
```

#### No normal, not clustered
```{r, fig.height=8, fig.width=10}
pY_mat_normtomedian[!grepl("normal", rownames(pY_mat_normtomedian) ),] %>% 
  pheatmap::pheatmap(col = colorRampPalette(c("navy", "white", "firebrick3"))(50), 
                     #labels_col = sub("_.*", "", colnames( pY_mat_normtomedian[!grepl("normal", rownames(pY_mat_normtomedian) ),] )), 
                     show_colnames = FALSE,
                     #scale = "column",
                     cluster_rows = FALSE)
```

### Phospho-Serines/Threonines 
#### All samples
```{r, fig.height=8, fig.width=10}
pST_mat_normtomedian %>% 
  pheatmap::pheatmap(col = colorRampPalette(c("navy", "white", "firebrick3"))(50), 
                     #labels_col = sub("_.*", "", colnames( pST_mat_normtomedian )), 
                     show_colnames = FALSE,
                     #scale = "column"   
                     )
```

#### No normal
```{r, fig.height=8, fig.width=10}
pST_mat_normtomedian[!grepl("normal", rownames(pST_mat_normtomedian) ),] %>% 
  pheatmap::pheatmap(col = colorRampPalette(c("navy", "white", "firebrick3"))(50), 
                     #labels_col = sub("_.*", "", colnames( pST_mat_normtomedian[!grepl("normal", rownames(pST_mat_normtomedian) ),] )), 
                     show_colnames = FALSE,
                     #scale = "column"  
                     )
```

#### No normal, not clustered
```{r, fig.height=8, fig.width=10}
pST_mat_normtomedian[!grepl("normal", rownames(pST_mat_normtomedian) ),] %>% 
  pheatmap::pheatmap(col = colorRampPalette(c("navy", "white", "firebrick3"))(50), 
                     #labels_col = sub("_.*", "", colnames( pST_mat_normtomedian[!grepl("normal", rownames(pST_mat_normtomedian) ),] )), 
                     show_colnames = FALSE,
                     #scale = "column",
                     cluster_rows = FALSE)
```

### Whole proteome
#### Clustered
```{r, fig.height=8, fig.width=10}
prot_mat_normtomedian %>% 
  pheatmap::pheatmap(col = colorRampPalette(c("navy", "white", "firebrick3"))(50), 
                     #labels_col = sub("_.*", "", colnames( pST_mat_normtomedian )), 
                     show_colnames = FALSE,
                     #scale = "column"   
                     )
```

## With missing values
```{r}
pY_NAs %>%
  mutate(namepep= paste0(HGNC_Symbol, "_", `Annotated Sequence`)) %>%
  select(-c("Sequence", "Annotated Sequence", "Master Protein Accessions", "Master Protein Descriptions", "HGNC_Symbol") ) %>% 
  pivot_longer(-namepep, names_to = "sample") %>%
  mutate(log2value = log2(value)) %>%
  ggplot(aes(sample, namepep, fill = log2value)) +
  geom_tile() +
  theme(axis.text.x = element_text(angle = 90)) +
  scale_fill_continuous(type = "viridis")

pST_NAs %>%
  mutate(namepep= paste0(HGNC_Symbol, "_", `Annotated Sequence`)) %>%
  select(-c("Sequence", "Annotated Sequence", "Master Protein Accessions", "Master Protein Descriptions", "HGNC_Symbol") ) %>% 
  pivot_longer(-namepep, names_to = "sample") %>%
  mutate(log2value = log2(value)) %>%
  ggplot(aes(sample, namepep, fill = log2value)) +
  geom_tile() +
  theme(axis.text.x = element_text(angle = 90)) +
  scale_fill_continuous(type = "viridis")
```

```{r}
pY_NAs %>%
  filter(HGNC_Symbol=="EGFR") %>%
  pivot_longer(-c("Sequence", "Annotated Sequence", "Master Protein Accessions", "Master Protein Descriptions", "HGNC_Symbol"), names_to = "sample") %>%
  separate(sample, into = c("type", "replicate"), sep = "-", remove = FALSE) %>%
  ggplot(aes(sample, value, fill = type)) +
  geom_col() +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90)) +
  facet_grid(~`Annotated Sequence`) +
  scale_y_log10() +
  scale_fill_manual(values=PGPalette[c(1,2,4,5)]) +
  ggtitle("EGFR pY peptides")

pY_NAs %>% filter(HGNC_Symbol == "PDGFRA")
pY_NAs %>% filter(HGNC_Symbol == "PDGFRB")

pST_NAs %>%
  filter(HGNC_Symbol=="EGFR")
```

# Session Info
```{r}
sessionInfo()
knitr::knit_exit()
```
